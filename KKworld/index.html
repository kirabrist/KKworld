<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>哈基米OS</title>
    <link rel="stylesheet" href="homescreen.css">
</head>
<body>
    <div class="phone-screen">
        <div class="widget-container">
            <div id="time-display" class="time-display">15:28</div>
            <div class="details-display"><span id="date-display">2024/05/06 星期三</span></div>
        </div>
        <main class="app-grid">
            <a href="chat.html" class="app-icon"><img src="images/qq_icon.svg" alt="聊天App"><span>我的AI伙伴</span></a>
        </main>
        <footer class="dock">
            <a href="#" class="dock-icon" id="phone-app-icon"><img src="images/phone_icon.svg" alt="电话"></a>
            <a href="#" class="dock-icon" id="messages-app-icon"><img src="images/messages_icon.svg" alt="信息"></a>
            <a href="#" class="dock-icon" id="settings-app-icon"><img src="images/settings_icon.svg" alt="设置"></a>
            <a href="#" class="dock-icon" id="camera-app-icon"><img src="images/camera_icon.svg" alt="相机"></a>
        </footer>
    </div>
    <div id="settings-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2>设置</h2>
                <button id="close-settings-btn" class="close-button">×</button>
            </div>
            <div class="modal-body">
                <div class="settings-section">
                    <h3>AI 连接设置</h3>
                    <p>输入您的代理平台地址和密钥，然后点击“获取模型列表”以加载您的专属模型。</p>
                    <div class="form-group">
                        <label for="api-endpoint-input">代理平台地址 (Endpoint)</label>
                        <input type="text" id="api-endpoint-input" placeholder="您的代理平台地址">
                    </div>
                    <div class="form-group">
                        <label for="api-key-input">API Key / 访问凭证</label>
                        <input type="password" id="api-key-input" placeholder="您的代理平台所需的密钥">
                    </div>
                    <div class="form-group model-group">
                        <label for="api-model-select">AI 模型 (Model)</label>
                        <div class="model-selection">
                            <select id="api-model-select" disabled><option>请先获取模型列表</option></select>
                            <button id="fetch-models-btn">获取模型列表</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="save-settings-btn" class="save-button">保存设置</button>
            </div>
        </div>
    </div>
    <script>
        (function() {
            const timeElement = document.getElementById('time-display');
            const dateElement = document.getElementById('date-display');
            const settingsModal = document.getElementById('settings-modal');
            const settingsAppIcon = document.getElementById('settings-app-icon');
            const closeSettingsBtn = document.getElementById('close-settings-btn');
            const saveSettingsBtn = document.getElementById('save-settings-btn');
            const apiKeyInput = document.getElementById('api-key-input');
            const apiEndpointInput = document.getElementById('api-endpoint-input');
            const apiModelSelect = document.getElementById('api-model-select');
            const fetchModelsBtn = document.getElementById('fetch-models-btn');

            function updateTime() { const now = new Date(); const hours = String(now.getHours()).padStart(2, '0'); const minutes = String(now.getMinutes()).padStart(2, '0'); timeElement.textContent = `${hours}:${minutes}`; const year = now.getFullYear(); const month = String(now.getMonth() + 1).padStart(2, '0'); const day = String(now.getDate()).padStart(2, '0'); const week = ['星期日', '星期一', '星期二', '星期三', '星期四', '星期五', '星期六'][now.getDay()]; dateElement.textContent = `${year}/${month}/${day} ${week}`; }
            function openSettings() {
                apiKeyInput.value = localStorage.getItem('hakimi-os-api-key') || '';
                apiEndpointInput.value = localStorage.getItem('hakimi-os-api-endpoint') || '';
                const savedModel = localStorage.getItem('hakimi-os-api-model');
                apiModelSelect.innerHTML = savedModel ? `<option>${savedModel}</option>` : '<option>请先获取模型列表</option>';
                apiModelSelect.disabled = !savedModel;
                settingsModal.style.display = 'flex';
            }
            function closeSettings() { settingsModal.style.display = 'none'; }
            async function fetchModels() {
                const apiKey = apiKeyInput.value.trim();
                const endpoint = apiEndpointInput.value.trim();
                if (!apiKey || !endpoint) { alert('请输入API Key和代理平台地址！'); return; }
                fetchModelsBtn.textContent = '获取中...';
                fetchModelsBtn.disabled = true;
                apiModelSelect.innerHTML = '<option>正在加载...</option>';
                apiModelSelect.disabled = true;
                try {
                    let requestUrl = endpoint.endsWith('/chat/completions') ? endpoint.replace('/chat/completions', '/models') : (endpoint.endsWith('/') ? endpoint : endpoint + '/') + 'v1/models';
                    const response = await fetch(requestUrl, { headers: { 'Authorization': `Bearer ${apiKey}` } });
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    const data = await response.json();
                    const models = (data.data || data).map(m => m.id || m.name).filter(id => id.toLowerCase().includes('gpt') || id.toLowerCase().includes('gemini') || id.toLowerCase().includes('claude'));
                    apiModelSelect.innerHTML = '';
                    if (models.length > 0) {
                        models.forEach(modelId => {
                            const option = document.createElement('option');
                            option.value = modelId;
                            option.textContent = modelId;
                            apiModelSelect.appendChild(option);
                        });
                        apiModelSelect.disabled = false;
                    } else { apiModelSelect.innerHTML = '<option>未找到可用模型</option>'; }
                } catch (error) {
                    console.error('获取模型列表失败:', error);
                    alert(`获取模型列表失败: ${error.message}。请检查Key或端点是否正确。`);
                    apiModelSelect.innerHTML = '<option>获取失败</option>';
                } finally {
                    fetchModelsBtn.textContent = '获取模型列表';
                    fetchModelsBtn.disabled = false;
                }
            }
            function saveSettings() {
                const apiKey = apiKeyInput.value.trim();
                const apiEndpoint = apiEndpointInput.value.trim();
                const apiModel = apiModelSelect.value;
                if (apiKey && apiEndpoint && apiModel && apiModel !== '获取失败' && apiModel !== '请先获取模型列表') {
                    localStorage.setItem('hakimi-os-api-key', apiKey);
                    localStorage.setItem('hakimi-os-api-endpoint', apiEndpoint);
                    localStorage.setItem('hakimi-os-api-model', apiModel);
                    alert('AI设置已保存！');
                    closeSettings();
                } else { alert('API Key、代理地址和有效模型为必填项！'); }
            }
            updateTime(); setInterval(updateTime, 1000);
            settingsAppIcon.addEventListener('click', (e) => { e.preventDefault(); openSettings(); });
            closeSettingsBtn.addEventListener('click', closeSettings);
            fetchModelsBtn.addEventListener('click', fetchModels);
            saveSettingsBtn.addEventListener('click', saveSettings);
            settingsModal.addEventListener('click', (e) => { if (e.target === settingsModal) { closeSettings(); } });
            document.getElementById('phone-app-icon').addEventListener('click', (e) => { e.preventDefault(); alert('电话应用施工中...'); });
            document.getElementById('messages-app-icon').addEventListener('click', (e) => { e.preventDefault(); alert('信息应用施工中...'); });
            document.getElementById('camera-app-icon').addEventListener('click', (e) => { e.preventDefault(); alert('相机应用施工中...'); });
        })();
    </script>
</body>
</html>