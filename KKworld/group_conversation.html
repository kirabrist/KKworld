<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ç¾¤èŠ</title>
    <link rel="stylesheet" href="conversation_style.css">
</head>
<body>
<div class="chat-container">
    <header class="header">
        <a href="chat.html" class="back-button"><</a>
        <div class="friend-info">
            <span id="friend-name" class="name">åŠ è½½ä¸­...</span>
            <span id="status-indicator" class="status">ğŸŸ¢ 0 äººåœ¨çº¿</span>
        </div>
        <img id="regenerate-btn" src="images/refresh_icon.svg" class="more-options" alt="é‡æ–°ç”Ÿæˆå›å¤" title="é‡æ–°ç”ŸæˆAIçš„æœ€æ–°å›å¤">
    </header>
    <main id="message-area" class="message-area"></main>

    <!-- æ–°å¢ï¼š@æåŠé¢æ¿çš„HTMLç»“æ„ -->
    <div id="at-mention-panel" class="at-mention-panel"></div>

    <div class="input-area">
        <div id="reply-preview" class="reply-preview"><div id="reply-preview-content"></div><button id="close-reply-preview">Ã—</button></div>
        <textarea id="message-input" placeholder="è¾“å…¥æ¶ˆæ¯..." rows="1"></textarea>
        <button id="transmit-button" title="å‘é€ç»™AIè¿›è¡Œå›å¤"><img src="images/transmit_icon.svg" alt="ä¼ è¾“"></button>
        <button id="send-button">å‘é€</button>
    </div>
    <footer class="action-bar">
        <img id="voice-message-btn" src="images/mic_icon.svg" alt="è¯­éŸ³"><img id="image-message-btn" src="images/image_icon.svg" alt="å›¾ç‰‡"><img id="camera-message-btn" src="images/camera_icon.svg" alt="ç›¸æœº"><img id="transfer-btn" src="images/wallet_icon.svg" alt="è½¬è´¦"><img id="emoji-btn" src="images/emoji_icon.svg" alt="è¡¨æƒ…"><img id="group-settings-btn" src="images/plus_icon.svg" alt="ç¾¤èŠè®¾ç½®">
    </footer>

    <!-- Modals... -->
    <div id="finance-menu" class="finance-menu"><div class="finance-menu-item" id="menu-direct-transfer">æŒ‡å®šè½¬è´¦</div><div class="finance-menu-item" id="menu-red-packet">å‘çº¢åŒ…</div></div>
    <div id="transfer-modal" class="modal-overlay"><div class="modal-content"><h2 id="transfer-title">æŒ‡å®šè½¬è´¦</h2><div class="transfer-form-group"><label>é€‰æ‹©æ”¶æ¬¾äºº</label><div id="member-select-list" class="member-select-list"></div></div><div class="transfer-form-group"><label for="transfer-amount-input">è½¬è´¦é‡‘é¢</label><input type="number" id="transfer-amount-input" placeholder="0.00" step="0.01"><div id="transfer-error" class="error-message"></div></div><div class="transfer-form-group"><label for="transfer-remark-input">å¤‡æ³¨ (æœ€å¤š20å­—)</label><input type="text" id="transfer-remark-input" maxlength="20"></div><div class="modal-actions"><button id="cancel-transfer-btn">å–æ¶ˆ</button><button id="confirm-transfer-btn" disabled>è½¬è´¦</button></div></div></div>
    <div id="red-packet-modal" class="modal-overlay"><div class="modal-content"><h2>å‘çº¢åŒ…</h2><div class="transfer-form-group"><label for="rp-amount-input">æ€»é‡‘é¢</label><input type="number" id="rp-amount-input" placeholder="0.00" step="0.01"><div id="rp-amount-error" class="error-message"></div></div><div class="transfer-form-group"><label for="rp-count-input">çº¢åŒ…ä¸ªæ•°</label><input type="number" id="rp-count-input" placeholder="å¡«å†™ä¸ªæ•°" step="1"><div id="rp-count-error" class="error-message"></div></div><div class="transfer-form-group"><label for="rp-remark-input">å¤‡æ³¨ (æœ€å¤š20å­—)</label><input type="text" id="rp-remark-input" maxlength="20" placeholder="æ­å–œå‘è´¢ï¼Œå¤§å‰å¤§åˆ©"></div><div class="modal-actions"><button id="cancel-rp-btn">å–æ¶ˆ</button><button id="confirm-rp-btn" disabled>å¡é’±è¿›çº¢åŒ…</button></div></div></div>
    <div id="red-packet-details-modal" class="modal-overlay"><div class="rp-details-content"><header class="rp-details-header"><h2>é¢†å–è¯¦æƒ…</h2><button class="rp-details-close-btn">Ã—</button></header><div class="rp-details-sender"><p id="rp-details-sender-name" class="rp-details-sender-name"></p><p id="rp-details-sender-remark" class="rp-details-sender-remark"></p><div id="rp-details-my-amount" class="rp-details-amount"></div></div><div class="rp-details-summary" id="rp-details-summary"></div><div class="rp-grabber-list" id="rp-grabber-list"></div><footer class="rp-details-footer">æ”¶åˆ°çš„çº¢åŒ…å·²å­˜å…¥ä½™é¢</footer></div></div>
    <div id="sticker-panel" class="sticker-panel"><div class="sticker-panel-header"><span>è¡¨æƒ…åŒ…</span><div><button id="add-sticker-btn">æ·»åŠ </button> <button id="close-sticker-panel-btn">å…³é—­</button></div></div><div id="sticker-grid" class="sticker-grid"></div></div>
    <input type="file" id="image-uploader" accept="image/*" style="display: none;"><input type="file" id="sticker-uploader" accept="image/*" style="display: none;">
    <div id="message-context-menu" class="context-menu">
        <!-- æ–°å¢ï¼š@ At é€‰é¡¹ -->
        <div id="at-message-btn" class="context-menu-item">@ At</div>
        <div id="reply-message-btn" class="context-menu-item">å¼•ç”¨</div>
        <div id="edit-message-btn" class="context-menu-item">ç¼–è¾‘</div>
        <div id="delete-message-btn" class="context-menu-item">åˆ é™¤</div>
    </div>
    <div id="group-settings-panel" class="group-settings-panel"><header class="settings-header"><button id="settings-back-btn" class="settings-back-btn"><</button><h2 class="settings-title">ç¾¤èŠè®¾ç½®</h2></header><main class="settings-content"><section class="settings-section"><div class="settings-section-header">ç¾¤èŠæˆå‘˜</div><div id="settings-member-grid" class="settings-member-grid"></div></section><section class="settings-section"><div class="settings-section-header">ç¾¤èŠä¿¡æ¯</div><div id="settings-group-name-item" class="settings-item"><span class="settings-item-label">ç¾¤èŠåç§°</span><div class="value-wrapper"><span id="settings-group-name-value" class="settings-item-value"></span><span class="settings-item-arrow">></span></div></div><div id="settings-group-announcement-item" class="settings-item"><span class="settings-item-label">ç¾¤å…¬å‘Š</span><div class="value-wrapper"><span id="settings-group-announcement-value" class="settings-item-value">æœªè®¾ç½®</span><span class="settings-item-arrow">></span></div></div><div id="settings-my-nickname-item" class="settings-item"><span class="settings-item-label">æˆ‘çš„æœ¬ç¾¤æ˜µç§°</span><div class="value-wrapper"><span id="settings-my-nickname-value" class="settings-item-value">æœªè®¾ç½®</span><span class="settings-item-arrow">></span></div></div></section><section class="settings-section"><div id="settings-manage-group-item" class="settings-item"><span class="settings-item-label">ç®¡ç†ç¾¤</span><span class="settings-item-arrow">></span></div></section><button id="exit-group-btn" class="exit-group-btn">é€€å‡ºç¾¤èŠ</button><a id="report-group-link" class="report-link">è¢«éªšæ‰°äº†ï¼Ÿä¸¾æŠ¥è¯¥ç¾¤</a></main></div>
</div>
<div id="member-select-modal" class="modal-overlay member-select-modal"><div class="modal-content"><div class="modal-header"><h2 id="member-select-title">é€‰æ‹©æˆå‘˜</h2><button id="close-member-select-modal" class="close-button">Ã—</button></div><div class="modal-body"><div id="invite-member-list" style="display: none;"></div><div id="remove-member-list" style="display: none;"></div></div><div class="modal-footer"><button id="confirm-member-select-btn" class="save-button">ç¡®å®š</button></div></div></div>
<div id="group-manage-modal" class="modal-overlay" ><div class="modal-content"><div class="modal-header"><h2>ç®¡ç†ç¾¤</h2><button id="close-group-manage-modal" class="close-button">Ã—</button></div><div class="modal-body"><div id="manage-member-list"></div></div></div></div>

<script>
(function() {
    const groupNameElement = document.getElementById('friend-name'), statusIndicator = document.getElementById('status-indicator'), messageArea = document.getElementById('message-area'), messageInput = document.getElementById('message-input'), sendButton = document.getElementById('send-button'), transmitButton = document.getElementById('transmit-button'), voiceMessageBtn = document.getElementById('voice-message-btn'), imageMessageBtn = document.getElementById('image-message-btn'), cameraMessageBtn = document.getElementById('camera-message-btn'), imageUploader = document.getElementById('image-uploader'), transferBtn = document.getElementById('transfer-btn'), emojiBtn = document.getElementById('emoji-btn'), stickerPanel = document.getElementById('sticker-panel'), stickerGrid = document.getElementById('sticker-grid'), addStickerBtn = document.getElementById('add-sticker-btn'), closeStickerPanelBtn = document.getElementById('close-sticker-panel-btn'), stickerUploader = document.getElementById('sticker-uploader'), contextMenu = document.getElementById('message-context-menu'), atMessageBtn = document.getElementById('at-message-btn'), replyBtn = document.getElementById('reply-message-btn'), editBtn = document.getElementById('edit-message-btn'), deleteBtn = document.getElementById('delete-message-btn'), regenerateBtn = document.getElementById('regenerate-btn'), replyPreview = document.getElementById('reply-preview'), replyPreviewContent = document.getElementById('reply-preview-content'), closeReplyPreviewBtn = document.getElementById('close-reply-preview'), atMentionPanel = document.getElementById('at-mention-panel'), financeMenu = document.getElementById('finance-menu'), menuDirectTransfer = document.getElementById('menu-direct-transfer'), menuRedPacket = document.getElementById('menu-red-packet'), transferModal = document.getElementById('transfer-modal'), memberSelectList = document.getElementById('member-select-list'), transferAmountInput = document.getElementById('transfer-amount-input'), transferRemarkInput = document.getElementById('transfer-remark-input'), confirmTransferBtn = document.getElementById('confirm-transfer-btn'), cancelTransferBtn = document.getElementById('cancel-transfer-btn'), transferError = document.getElementById('transfer-error'), redPacketModal = document.getElementById('red-packet-modal'), rpAmountInput = document.getElementById('rp-amount-input'), rpCountInput = document.getElementById('rp-count-input'), rpRemarkInput = document.getElementById('rp-remark-input'), confirmRpBtn = document.getElementById('confirm-rp-btn'), cancelRpBtn = document.getElementById('cancel-rp-btn'), rpAmountError = document.getElementById('rp-amount-error'), rpCountError = document.getElementById('rp-count-error'), rpDetailsModal = document.getElementById('red-packet-details-modal'), rpDetailsCloseBtn = rpDetailsModal.querySelector('.rp-details-close-btn'), groupSettingsBtn = document.getElementById('group-settings-btn'), groupSettingsPanel = document.getElementById('group-settings-panel'), settingsBackBtn = document.getElementById('settings-back-btn'), settingsMemberGrid = document.getElementById('settings-member-grid'), settingsGroupNameItem = document.getElementById('settings-group-name-item'), settingsGroupNameValue = document.getElementById('settings-group-name-value'), settingsGroupAnnouncementItem = document.getElementById('settings-group-announcement-item'), settingsGroupAnnouncementValue = document.getElementById('settings-group-announcement-value'), settingsMyNicknameItem = document.getElementById('settings-my-nickname-item'), settingsMyNicknameValue = document.getElementById('settings-my-nickname-value'), settingsManageGroupItem = document.getElementById('settings-manage-group-item'), exitGroupBtn = document.getElementById('exit-group-btn'), reportGroupLink = document.getElementById('report-group-link'), memberSelectModal = document.getElementById('member-select-modal'), closeMemberSelectModal = document.getElementById('close-member-select-modal'), memberSelectTitle = document.getElementById('member-select-title'), inviteMemberList = document.getElementById('invite-member-list'), removeMemberList = document.getElementById('remove-member-list'), confirmMemberSelectBtn = document.getElementById('confirm-member-select-btn'), groupManageModal = document.getElementById('group-manage-modal'), closeGroupManageModal = document.getElementById('close-group-manage-modal'), manageMemberList = document.getElementById('manage-member-list');
    let groupData = {}, groupMembers = {}, userData = {}, groupId = null, userStickers = [], lastMessageTimestamp = 0, longPressTimer, activeMessageId = null, activeMessageElement = null, replyingToMessageId = null, selectedTransferTargetId = null, currentMemberSelectionMode = null, selectedMembersForAction = [], isAtMentionActive = false, atMentionStartPosition = 0;
    const TEN_MINUTES_IN_MS = 10 * 60 * 1000;
    const DBHelper = { db: null, openDB: function() { return new Promise((resolve, reject) => { if (this.db) { return resolve(this.db); } const request = indexedDB.open('ChatDatabase', 2); request.onerror = (event) => reject("æ•°æ®åº“é”™è¯¯: " + event.target.errorCode); request.onsuccess = (event) => { this.db = event.target.result; resolve(this.db); }; request.onupgradeneeded = (event) => { const db = event.target.result; if (!db.objectStoreNames.contains('conversations')) { const store = db.createObjectStore('conversations', { keyPath: 'id', autoIncrement: true }); store.createIndex('conversationId', 'conversationId', { unique: false }); }}; }); }, addMessage: async function(conversationId, message) { const db = await this.openDB(); return new Promise((resolve, reject) => { const transaction = db.transaction(['conversations'], 'readwrite'); const store = transaction.objectStore('conversations'); message.conversationId = conversationId; const request = store.add(message); request.onsuccess = (event) => { message.id = event.target.result; resolve(message); }; request.onerror = (event) => reject("æ·»åŠ æ¶ˆæ¯å¤±è´¥: " + event.target.error); }); }, getMessages: async function(conversationId) { const db = await this.openDB(); return new Promise((resolve, reject) => { const transaction = db.transaction(['conversations'], 'readonly'); const store = transaction.objectStore('conversations'); const index = store.index('conversationId'); const request = index.getAll(conversationId); request.onsuccess = () => resolve(request.result.sort((a,b) => a.timestamp - b.timestamp)); request.onerror = (event) => reject("è·å–æ¶ˆæ¯å¤±è´¥: " + event.target.error); }); }, getMessageById: async function(id) { const db = await this.openDB(); return new Promise((resolve, reject) => { const transaction = db.transaction(['conversations'], 'readonly'); const store = transaction.objectStore('conversations'); const request = store.get(id); request.onsuccess = () => resolve(request.result); request.onerror = reject; }); }, deleteMessage: async function(id) { const db = await this.openDB(); return new Promise((resolve, reject) => { const transaction = db.transaction(['conversations'], 'readwrite'); const store = transaction.objectStore('conversations'); const request = store.delete(id); request.onsuccess = resolve; request.onerror = reject; }); }, updateMessage: async function(id, updateFn) { const db = await this.openDB(); return new Promise((resolve, reject) => { const transaction = db.transaction(['conversations'], 'readwrite'); const store = transaction.objectStore('conversations'); const getRequest = store.get(id); getRequest.onsuccess = () => { const message = getRequest.result; if (message) { updateFn(message); const updateRequest = store.put(message); updateRequest.onsuccess = () => resolve(message); updateRequest.onerror = reject; } else { reject('æœªæ‰¾åˆ°æ¶ˆæ¯'); } }; getRequest.onerror = reject; }); }, updateMessageContent: function(id, newContent) { return this.updateMessage(id, msg => msg.content = newContent); } };

    function simulateGrabRedPacket(packetMessage) { const packet = packetMessage.content, allMembers = ['me', ...Object.keys(groupMembers)], shuffledMembers = [...allMembers].sort(() => 0.5 - Math.random()), numberOfWinners = Math.min(packet.count, allMembers.length), luckyGrabbers = shuffledMembers.slice(0, numberOfWinners); let remainingAmount = packet.totalAmount, remainingCount = luckyGrabbers.length; if (remainingCount > 0) { const now = Date.now(); luckyGrabbers.forEach((grabberId, index) => { let grabbedAmount; if (index === luckyGrabbers.length - 1) { grabbedAmount = remainingAmount; } else { const maxGrab = remainingAmount - (remainingCount - 1) * 0.01; grabbedAmount = Math.random() * (maxGrab - 0.01) + 0.01; } grabbedAmount = parseFloat(grabbedAmount.toFixed(2)); packet.grabbers[grabberId] = { amount: grabbedAmount, timestamp: now + index * 100 }; remainingAmount -= grabbedAmount; remainingCount--; }); } packet.remainingAmount = 0; packet.remainingCount = 0; packet.isGrabbed = true; }
    async function handleOpenRedPacket(messageId) { showRedPacketDetails(messageId); }
    async function showRedPacketDetails(messageId) { const packetMessage = await DBHelper.getMessageById(messageId); if (!packetMessage) return; const packet = packetMessage.content, ownerInfo = packetMessage.sender === 'me' ? userData : (groupMembers[packetMessage.sender] || { nickname: 'æœªçŸ¥', name: 'æœªçŸ¥' }); document.getElementById('rp-details-sender-name').innerHTML = `<strong>${ownerInfo.nickname || ownerInfo.name}</strong>å‘å‡ºçš„æ‹¼æ‰‹æ°”çº¢åŒ…`; document.getElementById('rp-details-sender-remark').textContent = packet.remark; const myGrab = packet.grabbers['me'], myAmountDiv = document.getElementById('rp-details-my-amount'); if (myGrab) { myAmountDiv.innerHTML = `<small>Â¥</small>${myGrab.amount.toFixed(2)}`; myAmountDiv.style.display = 'block'; } else { myAmountDiv.style.display = 'none'; } const grabbedCount = Object.keys(packet.grabbers).length; let summaryText = `å·²é¢†å–${grabbedCount}/${packet.count}ä¸ª`; if (grabbedCount === packet.count) { const totalTime = (Math.max(...Object.values(packet.grabbers).map(g => g.timestamp)) - packetMessage.timestamp) / 1000; summaryText += `ï¼Œ${totalTime.toFixed(2)}ç§’è¢«æŠ¢å®Œ`; } document.getElementById('rp-details-summary').textContent = summaryText; const grabberListDiv = document.getElementById('rp-grabber-list'); grabberListDiv.innerHTML = ''; let bestLuck = { id: null, amount: 0 }; for(const grabberId in packet.grabbers) { if (packet.grabbers[grabberId].amount > bestLuck.amount) { bestLuck = { id: grabberId, amount: packet.grabbers[grabberId].amount }; } } const sortedGrabbers = Object.entries(packet.grabbers).sort((a, b) => a[1].timestamp - b[1].timestamp); for (const [grabberId, grabData] of sortedGrabbers) { const grabberInfo = grabberId === 'me' ? userData : (groupMembers[grabberId] || { nickname: 'æœªçŸ¥', name: 'æœªçŸ¥' }); const itemDiv = document.createElement('div'); itemDiv.className = 'grabber-item'; const grabTime = new Date(grabData.timestamp); const timeString = `${String(grabTime.getHours()).padStart(2, '0')}:${String(grabTime.getMinutes()).padStart(2, '0')}:${String(grabTime.getSeconds()).padStart(2, '0')}`; const isMeTag = grabberId === 'me' ? '<span class="my-tag">æˆ‘</span>' : ''; const isBestLuckBadge = grabberId === bestLuck.id ? '<span class="best-luck-badge">æ‰‹æ°”æœ€ä½³</span>' : ''; itemDiv.innerHTML = `<div class="grabber-info"><span class="grabber-name">${grabberInfo.nickname || grabberInfo.name} ${isMeTag}</span><span class="grabber-time">${timeString}</span></div><div class="grabber-amount"><span class="grabber-amount-value">${grabData.amount.toFixed(2)}å…ƒ</span>${isBestLuckBadge}</div>`; grabberListDiv.appendChild(itemDiv); } rpDetailsModal.style.display = 'flex'; }
    async function getAIResponse(chatHistory, apiKey, apiEndpoint, apiModel, proxyService, groupData, groupMembers) { let systemPrompt = localStorage.getItem('hakimi-os-system-prompt') || ''; systemPrompt += `\n\n## å½“å‰ç¾¤èŠä¿¡æ¯\nç¾¤èŠåç§°: ${groupData.name}\nç¾¤èŠæˆå‘˜åˆ—è¡¨:\n- ${userData.nickname || 'æˆ‘'} (ID: me)\n`; for (const memberId in groupMembers) { const member = groupMembers[memberId]; systemPrompt += `- ${member.nickname || member.name} (ID: ${member.id})\n`; } const lastMessage = chatHistory[chatHistory.length - 1]; if (lastMessage && lastMessage.type === 'red-packet' && lastMessage.content.isGrabbed) { systemPrompt += "\n## æœ€æ–°äº‹ä»¶ï¼šä¸€ä¸ªçº¢åŒ…åˆšè¢«å‘å‡ºï¼\n"; const packet = lastMessage.content; const aiGrabbed = Object.keys(groupMembers).filter(id => packet.grabbers[id]); if (aiGrabbed.length > 0) { aiGrabbed.forEach(id => { const member = groupMembers[id]; const grabInfo = packet.grabbers[id]; systemPrompt += `- ${member.nickname || member.name} (ä½ ) æŠ¢åˆ°äº† ${grabInfo.amount.toFixed(2)} å…ƒã€‚\n`; }); } else { systemPrompt += "- AIæˆå‘˜ä»¬è¿™æ¬¡æ²¡æœ‰æŠ¢åˆ°çº¢åŒ…ã€‚\n"; } } systemPrompt += "\nè¯·ä½ æ ¹æ®å¯¹è¯å†…å®¹ï¼Œé€‰æ‹©ä¸€ä¸ªåˆé€‚çš„è§’è‰²è¿›è¡Œå›å¤ã€‚å½“éœ€è¦ä½¿ç”¨å·¥å…·æ—¶ï¼Œå¿…é¡»æŒ‡å®šå‘è¨€è€…çš„IDã€‚"; const messagesForAI = [{ role: 'system', content: systemPrompt }]; for (const msg of chatHistory) { if (msg.sender === 'me') { let userContent = ''; if (msg.type === 'text') userContent = msg.content; else if (msg.type === 'image') { try { const imageUrl = await blobToDataUrl(msg.content); messagesForAI.push({ role: 'user', content: [{ type: 'image_url', image_url: { url: imageUrl } }, { type: 'text', text: `[msg_id: ${msg.id}]` }] }); continue; } catch (e) { console.error("å›¾ç‰‡Blobè½¬DataURLå¤±è´¥:", e); continue; } } else { userContent = `[ä¸€æ¡${msg.type}æ¶ˆæ¯]`; } if (msg.replyTo) { const originalMsg = await DBHelper.getMessageById(msg.replyTo); if (originalMsg) { let quotedText = originalMsg.type === 'text' ? originalMsg.content : `[ä¸€æ¡${originalMsg.type}æ¶ˆæ¯]`; userContent = `[å›å¤"${quotedText}"]: ${userContent}`; } } messagesForAI.push({ role: 'user', content: `${userContent} [msg_id: ${msg.id}]` }); } else { let assistantContent = ''; if (msg.tool_use_data) { assistantContent = JSON.stringify(msg.tool_use_data); } else if (msg.type === 'text') { assistantContent = msg.content; if (msg.replyTo) { assistantContent = `REPLY_TO(${msg.replyTo}): ${assistantContent}`; } } else { assistantContent = `[å‘é€äº†ä¸€æ¡${msg.type}æ¶ˆæ¯]`; } messagesForAI.push({ role: 'assistant', content: assistantContent, tool_calls: msg.tool_use_data ? [{id: 'call_abc', type: 'function', function: {name: msg.tool_use_data.tool_use, arguments: JSON.stringify(msg.tool_use_data.parameters)}}] : undefined }); } } statusIndicator.textContent = 'ç¾¤æˆå‘˜æ­£åœ¨è¾“å…¥...'; try { let chatEndpoint = apiEndpoint.endsWith('/') ? apiEndpoint.slice(0, -1) : apiEndpoint; if (!chatEndpoint.endsWith('/chat/completions')) { chatEndpoint += '/chat/completions'; } const encodedUrl = encodeURIComponent(chatEndpoint); const finalUrl = proxyService + encodedUrl; const response = await fetch(finalUrl, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` }, body: JSON.stringify({ model: apiModel, messages: messagesForAI, stream: false, tool_choice: "auto", tools: [ {type: 'function', function: {name: 'send_group_transfer', description: 'å‘ç¾¤èŠä¸­çš„æŒ‡å®šæˆå‘˜è½¬è´¦', parameters: {type: 'object', properties: {speaker_id: {type: 'string', description: 'å‘è¨€è€…çš„ID'}, target_id: {type: 'string', description: 'æ”¶æ¬¾äººçš„ID'}, amount: {type: 'number', description: 'è½¬è´¦é‡‘é¢'}, remark: {type: 'string', description: 'è½¬è´¦å¤‡æ³¨'}}, required: ['speaker_id', 'target_id', 'amount']}}}, {type: 'function', function: {name: 'send_group_red_packet', description: 'åœ¨ç¾¤èŠä¸­å‘ä¸€ä¸ªæ‹¼æ‰‹æ°”çº¢åŒ…', parameters: {type: 'object', properties: {speaker_id: {type: 'string', description: 'å‘çº¢åŒ…çš„äººçš„ID'}, total_amount: {type: 'number', description: 'çº¢åŒ…æ€»é‡‘é¢'}, count: {type: 'integer', description: 'çº¢åŒ…ä¸ªæ•°'}, remark: {type: 'string', description: 'çº¢åŒ…ç¥ç¦è¯­'}}, required: ['speaker_id', 'total_amount', 'count']}}} ] }) }); if (!response.ok) { const errorData = await response.text(); throw new Error(`APIè¿”å›é”™è¯¯ (çŠ¶æ€ç : ${response.status}): ${errorData}`); } const data = await response.json(); return data.choices[0].message; } catch (error) { console.error('è°ƒç”¨AIå¤±è´¥:', error); return { content: `(æŠ±æ­‰ï¼ŒAIè¿æ¥å‡ºç°é—®é¢˜: ${error.message}ã€‚è¯·æ£€æŸ¥è®¾ç½®)` }; } finally { statusIndicator.textContent = `ğŸŸ¢ ${Object.keys(groupMembers).length + 1} äººåœ¨çº¿`; } }
    async function processAIResponse(aiMessage) { if (!aiMessage) return; if (aiMessage.tool_calls) { for (const toolCall of aiMessage.tool_calls) { const args = JSON.parse(toolCall.function.arguments); const speakerId = args.speaker_id; if (!groupMembers[speakerId]) { console.warn(`AIæŒ‡å®šçš„å‘è¨€äºº(ID: ${speakerId})ä¸åœ¨ç¾¤é‡Œï¼Œæ“ä½œå–æ¶ˆã€‚`); continue; } let newMessage = { sender: speakerId, timestamp: Date.now() }; if (toolCall.function.name === 'send_group_transfer') { newMessage.type = 'transfer'; newMessage.content = { targetId: args.target_id, amount: parseFloat(args.amount).toFixed(2), remark: args.remark || '' }; } else if (toolCall.function.name === 'send_group_red_packet') { newMessage.type = 'red-packet'; newMessage.content = { totalAmount: parseFloat(args.total_amount), count: parseInt(args.count), remark: args.remark || 'æ­å–œå‘è´¢ï¼Œå¤§å‰å¤§åˆ©', grabbers: {} }; } if (newMessage.type) await sendMessageToScreen(newMessage); } } if (aiMessage.content) { const lines = aiMessage.content.split('\n').filter(line => line.trim() !== ''); for (const line of lines) { const memberIds = Object.keys(groupMembers); const randomSenderId = memberIds[Math.floor(Math.random() * memberIds.length)]; const textMessage = { sender: randomSenderId, content: line.trim(), type: 'text', timestamp: Date.now() }; await sendMessageToScreen(textMessage); await new Promise(resolve => setTimeout(resolve, Math.random() * 400 + 200)); } } }
    async function initializeChat() { const params = new URLSearchParams(window.location.search); groupId = params.get('groupId'); if (!groupId) { groupNameElement.textContent = 'é”™è¯¯ï¼šæœªæ‰¾åˆ°ç¾¤èŠ'; return; } const allConversations = JSON.parse(localStorage.getItem('conversations')) || []; let currentGroup = allConversations.find(c => c.id === groupId); if (!currentGroup) { groupNameElement.textContent = 'é”™è¯¯ï¼šç¾¤èŠä¸å­˜åœ¨'; return; } if (!currentGroup.ownerId) { currentGroup.ownerId = 'me'; } if (!currentGroup.admins) { currentGroup.admins = []; } if (!currentGroup.memberSettings) { currentGroup.memberSettings = {}; } groupData = currentGroup; const allFriends = JSON.parse(localStorage.getItem('friends')) || []; groupMembers = {}; if (groupData.friendIds) { groupData.friendIds.forEach(id => { const friend = allFriends.find(f => f.id === id); if (friend) groupMembers[id] = friend; }); } userData.avatar = localStorage.getItem('userAvatar') || 'images/default_avatar.png'; userData.nickname = localStorage.getItem('userNickname') || 'æˆ‘'; updateTopBar(); loadUserStickers(); await renderMessages(); }
    function updateTopBar() { groupNameElement.textContent = groupData.name; statusIndicator.textContent = `ğŸŸ¢ ${Object.keys(groupMembers).length + 1} äººåœ¨çº¿`; document.title = `åœ¨ ${groupData.name} çš„èŠå¤©`; }
    async function renderMessages() { messageArea.innerHTML = ''; lastMessageTimestamp = 0; try { const conversationHistory = await DBHelper.getMessages(groupId); for (const msg of conversationHistory) { await appendMessageToUI(msg, false); } } catch (error) { console.error("æ¸²æŸ“æ¶ˆæ¯å¤±è´¥:", error); } messageArea.scrollTop = messageArea.scrollHeight; }
    function formatTimestamp(ts) { const date = new Date(ts); const month = date.getMonth() + 1; const day = date.getDate(); const hours = String(date.getHours()).padStart(2, '0'); const minutes = String(date.getMinutes()).padStart(2, '0'); return `${month}.${day} ${hours}:${minutes}`; }
    async function appendMessageToUI(msg, shouldScroll) { const newTimestamp = msg.timestamp; if (lastMessageTimestamp > 0 && (newTimestamp - lastMessageTimestamp > TEN_MINUTES_IN_MS)) { const timestampDiv = document.createElement('div'); timestampDiv.className = 'timestamp-separator'; timestampDiv.textContent = formatTimestamp(newTimestamp); messageArea.appendChild(timestampDiv); } lastMessageTimestamp = newTimestamp; const messageWrapper = document.createElement('div'); messageWrapper.className = 'message-wrapper'; messageWrapper.dataset.id = msg.id; const avatarImg = document.createElement('img'); avatarImg.className = 'avatar'; const senderInfo = msg.sender === 'me' ? userData : (groupMembers[msg.sender] || { nickname: 'æœªçŸ¥æˆå‘˜', avatar: 'images/default_avatar.png' }); avatarImg.src = senderInfo.avatar || 'images/default_avatar.png'; const contentWrapper = document.createElement('div'); contentWrapper.className = 'message-content-wrapper'; const nicknameDiv = document.createElement('div'); nicknameDiv.className = 'sender-nickname'; const senderSettings = groupData.memberSettings[msg.sender] || {}; let titleHTML = ''; if (groupData.ownerId === msg.sender) { titleHTML = `<span class="title-tag owner-tag">${senderSettings.title || 'ç¾¤ä¸»'}</span>`; } else if (groupData.admins.includes(msg.sender)) { titleHTML = `<span class="title-tag admin-tag">${senderSettings.title || 'ç®¡ç†'}</span>`; } else if (senderSettings.title) { titleHTML = `<span class="title-tag custom-title-tag">${senderSettings.title}</span>`; } const displayName = senderSettings.nickname || senderInfo.nickname || senderInfo.name || 'æˆ‘'; nicknameDiv.innerHTML = `${titleHTML}${displayName}`; contentWrapper.appendChild(nicknameDiv); const messageDiv = document.createElement('div'); messageDiv.className = 'message'; messageDiv.dataset.type = msg.type; if (msg.replyTo) { const originalMsg = await DBHelper.getMessageById(msg.replyTo); if (originalMsg) { const quoteDiv = document.createElement('div'); quoteDiv.className = 'quoted-message'; let quoteContent = originalMsg.type === 'text' ? originalMsg.content : `[ä¸€æ¡${originalMsg.type}æ¶ˆæ¯]`; const authorInfo = originalMsg.sender === 'me' ? userData : (groupMembers[originalMsg.sender] || { nickname: 'æœªçŸ¥' }); const authorName = (groupData.memberSettings[originalMsg.sender] || {}).nickname || authorInfo.nickname || authorInfo.name || 'æˆ‘'; quoteDiv.innerHTML = `<span class="quoted-author">${authorName}</span><p class="quoted-text">${quoteContent}</p>`; messageDiv.appendChild(quoteDiv); } } let messageContentHTML = ''; if (msg.type === 'text') { messageDiv.classList.add('text'); messageContentHTML = `<p>${msg.content}</p>`; } else if (msg.type === 'voice') { messageDiv.classList.add('voice'); messageContentHTML = `<div class="voice-display"><div class="sound-waves">...</div><span class="duration">${msg.duration}"</span></div>`; } else if (msg.type === 'image') { messageDiv.classList.add('image'); try { const imageUrl = await blobToDataUrl(msg.content); messageContentHTML = `<img src="${imageUrl}" alt="å‘é€çš„å›¾ç‰‡">`; } catch (e) { messageContentHTML = `<p>[å›¾ç‰‡åŠ è½½å¤±è´¥]</p>`; } } else if (msg.type === 'camera') { messageDiv.classList.add('camera'); messageContentHTML = `<div class="camera-placeholder"><p>[${msg.content}]</p></div>`; } else if (msg.type === 'transfer') { messageDiv.classList.add('transfer'); const targetInfo = msg.content.targetId === 'me' ? userData : (groupMembers[msg.content.targetId] || {nickname: 'æœªçŸ¥æˆå‘˜'}); const remarkText = msg.content.remark ? msg.content.remark : 'è½¬è´¦'; messageContentHTML = `<div class="transfer-content"><div class="transfer-header"><span>ğŸ’°</span><span>è½¬è´¦ç»™ ${targetInfo.nickname}</span></div><div class="transfer-amount"><small>Â¥</small>${msg.content.amount}</div><div class="transfer-remark">${remarkText}</div></div><div class="transfer-footer">å“ˆåŸºç±³OS è½¬è´¦</div>`; } else if (msg.type === 'red-packet') { messageDiv.classList.add('red-packet', 'opened'); messageContentHTML = `<div class="red-packet-content"><div class="red-packet-header"><span>ğŸ§§</span><span class="red-packet-remark">${msg.content.remark}</span></div></div><div class="red-packet-footer">å“ˆåŸºç±³OS çº¢åŒ…</div>`; messageDiv.onclick = () => handleOpenRedPacket(msg.id); } else if (msg.type === 'sticker') { messageDiv.classList.add('sticker'); messageContentHTML = `<img src="${msg.content}" alt="è¡¨æƒ…åŒ…">`; } messageDiv.innerHTML += messageContentHTML; contentWrapper.appendChild(messageDiv); if (msg.sender === 'me') { messageWrapper.classList.add('sent'); messageWrapper.appendChild(contentWrapper); messageWrapper.appendChild(avatarImg); } else { messageWrapper.classList.add('received'); messageWrapper.appendChild(avatarImg); messageWrapper.appendChild(contentWrapper); } messageArea.appendChild(messageWrapper); if (shouldScroll !== false) messageArea.scrollTop = messageArea.scrollHeight; }
    async function sendMessageToScreen(msgObject) { if(msgObject.type === 'red-packet' && !msgObject.content.isGrabbed) { simulateGrabRedPacket(msgObject); } const savedMsg = await DBHelper.addMessage(groupId, msgObject); let lastMessageText; if (savedMsg.type === 'text') { lastMessageText = savedMsg.content; } else { lastMessageText = `[${{voice: 'è¯­éŸ³', image: 'å›¾ç‰‡', camera: 'ç…§ç‰‡', transfer: 'è½¬è´¦', sticker: 'è¡¨æƒ…', 'red-packet': 'çº¢åŒ…'}[savedMsg.type]}]`; } updateConversationList(lastMessageText, savedMsg.sender); await appendMessageToUI(savedMsg); }
    function handleTextInput() { const text = messageInput.value.trim(); if (text === '') return; const newMessage = { sender: 'me', content: text, type: 'text', timestamp: Date.now() }; if(replyingToMessageId) { newMessage.replyTo = replyingToMessageId; } sendMessageToScreen(newMessage); messageInput.value = ''; messageInput.style.height = 'auto'; messageInput.focus(); cancelReply(); }
    async function handleTransmitToAI() { const apiKey = localStorage.getItem('hakimi-os-api-key'); const apiEndpoint = localStorage.getItem('hakimi-os-api-endpoint'); const apiModel = localStorage.getItem('hakimi-os-api-model'); const proxyService = localStorage.getItem('hakimi-os-proxy'); if (!apiKey || !apiEndpoint || !apiModel) { await processAIResponse({ content: `(é”™è¯¯: è¯·å…ˆåœ¨ä¸»å±å¹•çš„è®¾ç½®ä¸­å®Œæ•´é…ç½®ä»£ç†ã€API Keyã€ç«¯ç‚¹å’Œæ¨¡å‹ã€‚)` }); return; } const history = await DBHelper.getMessages(groupId); const aiMessage = await getAIResponse(history, apiKey, apiEndpoint, apiModel, proxyService, groupData, groupMembers); await processAIResponse(aiMessage); }
    async function handleRegenerate() { if (!confirm('ç¡®å®šè¦é‡æ–°ç”ŸæˆAIçš„æœ€æ–°å›å¤å—ï¼Ÿæ­¤æ“ä½œä¼šåˆ é™¤AIçš„æœ€åä¸€è½®æ¶ˆæ¯ã€‚')) return; const history = await DBHelper.getMessages(groupId); if (history.length === 0) return; let lastUserMessageIndex = -1; for (let i = history.length - 1; i >= 0; i--) { if (history[i].sender === 'me') { lastUserMessageIndex = i; break; } } const idsToDelete = []; if (lastUserMessageIndex === history.length - 1) { alert('æœ€åä¸€æ¡æ¶ˆæ¯æ˜¯æ‚¨å‘é€çš„ï¼Œæ²¡æœ‰AI å›å¤å¯ä»¥é‡æ–°ç”Ÿæˆã€‚'); return; } for (let i =  lastUserMessageIndex + 1; i < history.length; i++) { idsToDelete.push(history[i].id); } if (idsToDelete.length === 0) { alert('æœªæ‰¾åˆ°å¯é‡æ–°ç”Ÿæˆçš„AIå›å¤ã€‚'); return; } await Promise.all(idsToDelete.map(id => DBHelper.deleteMessage(id))); await renderMessages(); await handleTransmitToAI(); }
    async function handleStartReply() { contextMenu.style.display = 'none'; if (activeMessageId) { replyingToMessageId = activeMessageId; const originalMsg = await DBHelper.getMessageById( replyingToMessageId); if (originalMsg) { let previewText = ''; if (originalMsg.type === 'text') previewText = originalMsg.content; else previewText = `[ä¸€æ¡${originalMsg.type}æ¶ˆæ¯]`; const authorInfo = originalMsg.sender === 'me' ? userData : (groupMembers[originalMsg.sender] || { nickname: 'æœªçŸ¥' }); const authorName = (groupData.memberSettings[originalMsg.sender] || {}).nickname || authorInfo.nickname || authorInfo.name || 'æˆ‘'; replyPreviewContent.textContent = `${authorName}: ${previewText}`; replyPreview.style.display = 'flex'; messageInput.focus(); } } }
    function cancelReply() { replyingToMessageId = null; replyPreview.style.display = 'none'; }
    function handleVoiceInput () { const text = prompt("è¯·è¾“å…¥è¦è½¬ä¸ºè¯­éŸ³çš„æ¶ˆæ¯å†…å®¹ï¼š"); if (text && text.trim() !== '') { const duration = Math.max(1, Math.round(text.length / 4)); const newMessage = { sender: 'me', content: text.trim(), type: 'voice', duration: duration, timestamp: Date.now() }; sendMessageToScreen(newMessage); } }
    async function handleImageUpload(event) { const file = event.target.files[0]; if (!file) return; try { statusIndicator.textContent = 'æ­£åœ¨å‹ç¼©å›¾ç‰‡...'; const compressedBlob = await resizeAndCompressImage(file); const newMessage = { sender: 'me', content: compressedBlob, type: 'image', timestamp: Date.now() }; await sendMessageToScreen(newMessage); } catch (error) { console.error("å›¾ç‰‡å‹ç¼©å¤±è´¥:", error); alert("å›¾ç‰‡å¤„ç†å¤±è´¥ï¼Œè¯·å°è¯•å…¶ä»–å›¾ç‰‡ã€‚"); } finally { statusIndicator.textContent = `ğŸŸ¢ ${Object.keys(groupMembers).length + 1} äººåœ¨çº¿`; event.target.value = ''; } }
    function handleCameraInput() { const text = prompt("è¯·ç®€çŸ­æè¿°æ‚¨â€œæ‹æ‘„â€çš„ç…§ç‰‡ï¼š"); if (text && text.trim() !== '') { const newMessage = { sender: 'me', content: text.trim(), type: 'camera', timestamp: Date.now() }; sendMessageToScreen(newMessage); } }
    function updateConversationList(lastMessage, sender) { let conversations = JSON.parse(localStorage.getItem('conversations')) || []; const conversationIndex = conversations.findIndex(c => c.id === groupId); if (conversationIndex > -1) { const senderInfo = sender === 'me' ? userData : (groupMembers[sender] || { nickname: 'æœªçŸ¥' }); const myNickname = (groupData.memberSettings['me'] || {}).nickname; const senderNickname = (groupData.memberSettings[sender] || {}).nickname; const prefix = sender === 'me' ? '' : `${senderNickname || senderInfo.nickname || senderInfo.name}: `; conversations[conversationIndex].lastMessage = prefix + lastMessage; conversations[conversationIndex].time = new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' }); const itemToMove = conversations.splice(conversationIndex, 1)[0]; conversations.unshift(itemToMove); localStorage.setItem('conversations', JSON.stringify(conversations)); } }
    function loadUserStickers() { userStickers = JSON.parse(localStorage.getItem('userStickers')) || []; }
    function saveUserStickers() { localStorage.setItem('userStickers', JSON.stringify(userStickers)); }
    function renderStickerGrid() { stickerGrid.innerHTML = ''; userStickers.forEach(stickerSrc => { const stickerItem = document.createElement('div'); stickerItem.className = 'sticker-item'; stickerItem.innerHTML = `<img src="${stickerSrc}" alt="sticker">`; stickerItem.onclick = () => { sendSticker(stickerSrc); }; stickerGrid.appendChild(stickerItem); }); }
    function handleAddSticker() { const choice = confirm("æ·»åŠ ç½‘ç»œå›¾ç‰‡å—ï¼Ÿ (ç‚¹'å–æ¶ˆ'ä»¥ä¸Šä¼ æœ¬åœ°æ–‡ä»¶)"); if (choice) { const url = prompt("è¯·è¾“å…¥å›¾ç‰‡é“¾æ¥ (URL):"); if (url) { userStickers.push(url); saveUserStickers(); renderStickerGrid(); } } else { stickerUploader.click(); } }
    function handleStickerUpload(event) { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (e) => { userStickers.push(e.target.result); saveUserStickers(); renderStickerGrid(); }; reader.readAsDataURL(file); event.target.value = ''; }
    function sendSticker(src) { const newMessage = { sender: 'me', content: src, type: 'sticker', timestamp: Date.now() }; sendMessageToScreen(newMessage); stickerPanel.style.display = 'none'; }
    function handleDirectTransfer() { selectedTransferTargetId = null; memberSelectList.innerHTML = ''; Object.values(groupMembers).forEach(member => { const item = document.createElement('div'); item.className = 'member-select-item'; item.dataset.id = member.id; item.innerHTML = `<img src="${member.avatar || 'images/default_avatar.png'}"><span>${member.nickname || member.name}</span>`; item.onclick = () => { document.querySelectorAll('.member-select-item').forEach(el => el.classList.remove('selected')); item.classList.add('selected'); selectedTransferTargetId = member.id; validateTransferAmount(); }; memberSelectList.appendChild(item); }); transferModal.style.display = 'flex'; validateTransferAmount(); }
    function handleRedPacket() { redPacketModal.style.display = 'flex'; validateRp(); }
    function handleConfirmTransfer() { const amount = parseFloat(transferAmountInput.value); const remark = transferRemarkInput.value.trim(); const newMessage = { sender: 'me', content: { targetId: selectedTransferTargetId, amount: amount.toFixed(2), remark: remark || ' ' }, type: 'transfer', timestamp: Date.now() }; sendMessageToScreen(newMessage); transferModal.style.display = 'none'; transferAmountInput.value = ''; transferRemarkInput.value = ''; }
    function validateTransferAmount() { const amount = parseFloat(transferAmountInput.value); let isValid = true; if (!selectedTransferTargetId) { isValid = false; } if (isNaN(amount) || amount <= 0) { transferError.textContent = 'é‡‘é¢å¿…é¡»å¤§äº0'; isValid = false; } else if (amount > 50000) { transferError.textContent = 'å•ç¬”è½¬è´¦é‡‘é¢ä¸èƒ½è¶…è¿‡50,000'; isValid = false; } else { transferError.textContent = ''; } confirmTransferBtn.disabled = !isValid; }
    function handleConfirmRp() { const totalAmount = parseFloat(rpAmountInput.value); const count = parseInt(rpCountInput.value); const remark = rpRemarkInput.value.trim(); const newMessage = { sender: 'me', type: 'red-packet', timestamp: Date.now(), content: { totalAmount: totalAmount, count: count, remark: remark || 'æ­å–œå‘è´¢ï¼Œå¤§å‰å¤§åˆ©', grabbers: {} } }; sendMessageToScreen(newMessage); redPacketModal.style.display = 'none'; rpAmountInput.value = ''; rpCountInput.value = ''; rpRemarkInput.value = ''; }
    function validateRp() { const amount = parseFloat(rpAmountInput.value); const count = parseInt(rpCountInput.value); let isAmountValid = true, isCountValid = true; const totalMembers = Object.keys(groupMembers).length + 1; if (isNaN(amount) || amount <= 0) { rpAmountError.textContent = 'æ€»é‡‘é¢å¿…é¡»å¤§äº0'; isAmountValid = false; } else if (amount > 20000) { rpAmountError.textContent = 'çº¢åŒ…æ€»é‡‘é¢ä¸èƒ½è¶…è¿‡20,000'; isAmountValid = false; } else { rpAmountError.textContent = ''; } if (isNaN(count) || count <= 0) { rpCountError.textContent = 'çº¢åŒ…ä¸ªæ•°å¿…é¡»å¤§äº0'; isCountValid = false; } else if (count > 100) { rpCountError.textContent = 'ä¸€æ¬¡æœ€å¤šå‘100ä¸ªçº¢åŒ…'; isCountValid = false; } else if (amount / count < 0.01) { rpCountError.textContent = 'å•ä¸ªçº¢åŒ…é‡‘é¢ä¸èƒ½ä½äº0.01'; isAmountValid = false; } else { rpCountError.textContent = ''; } confirmRpBtn.disabled = !(isAmountValid && isCountValid); }
    function showAtMentionPanel() { atMentionPanel.innerHTML = ''; const allMembers = [{ id: 'me', ...userData }, ...Object.values(groupMembers)]; allMembers.forEach(member => { const item = document.createElement('div'); item.className = 'at-mention-item'; const memberSettings = groupData.memberSettings[member.id] || {}; const displayName = memberSettings.nickname || member.nickname || member.name; item.innerHTML = `<img src="${member.avatar || 'images/default_avatar.png'}" class="at-mention-avatar"> <span class="at-mention-name">${displayName}</span>`; item.onclick = () => insertMention(displayName); atMentionPanel.appendChild(item); }); atMentionPanel.style.display = 'block'; }
    function hideAtMentionPanel() { isAtMentionActive = false; atMentionPanel.style.display = 'none'; }
    function insertMention(nickname) { const text = messageInput.value; const newText = text.slice(0, atMentionStartPosition) + `@${nickname} ` + text.slice(atMentionStartPosition + 1); messageInput.value = newText; const newCursorPos = atMentionStartPosition + nickname.length + 2; messageInput.setSelectionRange(newCursorPos, newCursorPos); hideAtMentionPanel(); messageInput.focus(); }
    async function handleAtFromMenu() { contextMenu.style.display = 'none'; if (!activeMessageId) return; const msg = await DBHelper.getMessageById(activeMessageId); if (!msg) return; const senderInfo = msg.sender === 'me' ? userData : (groupMembers[msg.sender] || { nickname: 'æœªçŸ¥' }); const senderNickname = (groupData.memberSettings[msg.sender] || {}).nickname || senderInfo.nickname || senderInfo.name; const currentText = messageInput.value; const mentionText = `@${senderNickname} `; messageInput.value = currentText + mentionText; messageInput.focus(); }
    function openGroupSettings() { renderSettingsMemberGrid(); settingsGroupNameValue.textContent = groupData.name; settingsGroupAnnouncementValue.textContent = groupData.announcement || 'æœªè®¾ç½®'; const myNickname = (groupData.memberSettings['me'] || {}).nickname; settingsMyNicknameValue.textContent = myNickname || 'æœªè®¾ç½®'; settingsManageGroupItem.style.display = groupData.ownerId === 'me' ? 'flex' : 'none'; groupSettingsPanel.classList.add('show'); }
    function closeGroupSettings() { groupSettingsPanel.classList.remove('show'); }
    function saveGroupData() { let conversations = JSON.parse(localStorage.getItem('conversations')) || []; const index = conversations.findIndex(c => c.id === groupId); if (index > -1) { conversations[index] = groupData; localStorage.setItem('conversations', JSON.stringify(conversations)); } }
    function renderSettingsMemberGrid() { settingsMemberGrid.innerHTML = ''; const allMembers = [{ id: 'me', ...userData }, ...Object.values(groupMembers)]; allMembers.forEach(member => { const item = document.createElement('div'); item.className = 'member-avatar-item'; const memberSettings = groupData.memberSettings[member.id] || {}; item.innerHTML = `<img src="${member.avatar}" alt=""><span >${memberSettings.nickname || member.nickname || member.name}</span>`; settingsMemberGrid.appendChild(item); }); if (groupData.ownerId === 'me' || groupData.admins.includes('me')) { const inviteItem = document.createElement('div'); inviteItem.className = 'member-avatar-item'; inviteItem.innerHTML = `<img src="images/plus_icon.svg" alt="é‚€è¯·" style="background-color:#eee; border-radius:25px; padding:10px; box-sizing: border-box;"><span>é‚€è¯·</span>`; inviteItem.onclick = () => openMemberSelectModal('invite'); settingsMemberGrid.appendChild(inviteItem); const removeItem = document.createElement('div'); removeItem.className = 'member-avatar-item'; removeItem.innerHTML = `<img src="images/minus_icon.svg" alt="ç§»é™¤" style="background-color:#eee; border-radius:25px; padding:10px; box-sizing: border-box;"><span>ç§»é™¤</span>`; removeItem.onclick = () => openMemberSelectModal('remove'); settingsMemberGrid.appendChild(removeItem); } }
    function openMemberSelectModal(mode) { currentMemberSelectionMode = mode; selectedMembersForAction = []; inviteMemberList.innerHTML = ''; removeMemberList.innerHTML = ''; if (mode === 'invite') { memberSelectTitle.textContent = 'é‚€è¯·æ–°æˆå‘˜'; inviteMemberList.style.display = 'block'; removeMemberList.style.display = 'none'; const allFriends = JSON.parse(localStorage.getItem('friends')) || []; const nonMembers = allFriends.filter(f => !groupData.friendIds.includes(f.id)); nonMembers.forEach(friend => { const item = document.createElement('label'); item.className = 'invite-member-item'; item.innerHTML = `<input type="checkbox" data-id="${friend.id}"><span>${friend.nickname || friend.name}</span>`; inviteMemberList.appendChild(item); }); } else if (mode === 'remove') { memberSelectTitle.textContent = 'ç§»é™¤ç¾¤æˆå‘˜'; inviteMemberList.style.display = 'none'; removeMemberList.style.display = 'block'; const membersToRemove = Object.values(groupMembers).filter(member => { return groupData.ownerId === 'me' ? member.id !== groupData.ownerId : !groupData.admins.includes(member.id); }); membersToRemove.forEach(member => { const item = document.createElement('label'); item.className = 'remove-member-item'; item.innerHTML = `<input type="checkbox" data-id="${member.id}"><span>${member.nickname || member.name}</span>`; removeMemberList.appendChild(item); }); } memberSelectModal.style.display = 'flex'; }
    function handleConfirmMemberSelection() { if (currentMemberSelectionMode === 'invite') { const selectedCheckboxes = inviteMemberList.querySelectorAll('input[type="checkbox"]:checked'); selectedMembersForAction = Array.from(selectedCheckboxes).map(cb => cb.dataset.id); groupData.friendIds.push(...selectedMembersForAction); selectedMembersForAction.forEach(id => { const friend = (JSON.parse(localStorage.getItem('friends')) || []).find(f => f.id === id); if (friend) groupMembers[id] = friend; }); } else if (currentMemberSelectionMode === 'remove') { const selectedCheckboxes = removeMemberList.querySelectorAll('input[type="checkbox"]:checked'); selectedMembersForAction = Array.from(selectedCheckboxes).map(cb => cb.dataset.id); groupData.friendIds = groupData.friendIds.filter(id => !selectedMembersForAction.includes(id)); selectedMembersForAction.forEach(id => delete groupMembers[id]); } saveGroupData(); renderSettingsMemberGrid(); updateTopBar(); memberSelectModal.style.display = 'none'; }
    function handleChangeGroupName() { const newName = prompt('è¾“å…¥æ–°çš„ç¾¤èŠåç§°:', groupData.name); if (newName && newName.trim() !== '') { groupData.name = newName.trim(); saveGroupData(); settingsGroupNameValue.textContent = groupData.name; updateTopBar(); } }
    function handleChangeGroupAnnouncement() { const newAnnouncement = prompt('è¾“å…¥æ–°çš„ç¾¤å…¬å‘Š:', groupData.announcement || ''); if (newAnnouncement !== null) { groupData.announcement = newAnnouncement.trim(); saveGroupData(); settingsGroupAnnouncementValue.textContent = groupData.announcement || 'æœªè®¾ç½®'; } }
    function handleChangeMyNickname() { const currentNickname = (groupData.memberSettings['me'] || {}).nickname || ''; const newNickname = prompt('è¾“å…¥æˆ‘çš„æœ¬ç¾¤æ˜µç§°:', currentNickname); if (newNickname !== null) { if (!groupData.memberSettings['me']) groupData.memberSettings['me'] = {}; groupData.memberSettings['me'].nickname = newNickname.trim(); saveGroupData(); settingsMyNicknameValue.textContent = newNickname.trim() || 'æœªè®¾ç½®'; } }
    function openGroupManageModal() { manageMemberList.innerHTML = ''; const allMembers = [{ id: 'me', ...userData }, ...Object.values(groupMembers)]; allMembers.forEach(member => { const memberSettings = groupData.memberSettings[member.id] || {}; const item = document.createElement('div'); item.className = 'member-item'; let titleHTML = '', actionsHTML = '', memberName = member.nickname || member.name; if (groupData.ownerId === member.id) { titleHTML = `<span class="title-tag owner-tag">${memberSettings.title || 'ç¾¤ä¸»'}</span>`; if (groupData.ownerId === 'me') { actionsHTML = `<button data-id="${member.id}" data-action="edit-title">æ”¹å¤´è¡”</button>`; } } else if (groupData.admins.includes(member.id)) { titleHTML = `<span class="title-tag admin-tag">${memberSettings.title || 'ç®¡ç†'}</span>`; if (groupData.ownerId === 'me') { actionsHTML = `<button data-id="${member.id}" data-action="remove-admin">æ’¤é”€ç®¡ç†</button><button data-id="${member.id}" data-action="edit-title">æ”¹å¤´è¡”</button>`; } } else { if (memberSettings.title) { titleHTML = `<span class="title-tag custom-title-tag">${memberSettings.title}</span>`; } if (groupData.ownerId === 'me') { actionsHTML = `<button data-id="${member.id}" data-action="set-admin">è®¾ä¸ºç®¡ç†</button><button data-id="${member.id}" data-action="edit-title">æ”¹å¤´è¡”</button>`; } } if(groupData.ownerId === 'me' && member.id !== 'me') { actionsHTML += `<button data-id="${member.id}" data-action="transfer-owner">è½¬è®©ç¾¤ä¸»</button>`; } item.innerHTML = `<img src="${member.avatar}" alt=""><div class="member-details"><div class="name-wrapper"><span class="name">${memberName}</span></div>${titleHTML}</div><div class="member-actions">${actionsHTML}</div>`; manageMemberList.appendChild(item); }); groupManageModal.style.display = 'flex'; }
    function handleManageActions(e) { const target = e.target; const action = target.dataset.action; const memberId = target.dataset.id; if (!action || !memberId) return; if (action === 'set-admin') { if (!groupData.admins.includes(memberId)) groupData.admins.push(memberId); } else if (action === 'remove-admin') { groupData.admins = groupData.admins.filter(id => id !== memberId); } else if (action === 'edit-title') { const memberInfo = memberId === 'me' ? userData : groupMembers[memberId]; const newTitle = prompt(`ä¸º ${memberInfo.nickname || memberInfo.name} è®¾ç½®æ–°å¤´è¡”:`); if (newTitle !== null) { if (!groupData.memberSettings[memberId]) groupData.memberSettings[memberId] = {}; groupData.memberSettings[memberId].title = newTitle.trim(); } } else if (action === 'transfer-owner') { const memberInfo = groupMembers[memberId]; if (confirm(`ç¡®å®šè¦å°†ç¾¤ä¸»è½¬è®©ç»™ ${memberInfo.nickname || memberInfo.name} å—ï¼Ÿæ­¤æ“ä½œä¸å¯é€†ï¼`)) { const oldOwnerId = groupData.ownerId; groupData.ownerId = memberId; groupData.admins = groupData.admins.filter(id => id !== memberId); if (!groupData.admins.includes(oldOwnerId)) { groupData.admins.push(oldOwnerId); } } } saveGroupData(); openGroupManageModal(); renderMessages(); }
    function handleExitGroup() { if (confirm('ç¡®å®šè¦é€€å‡ºç¾¤èŠå—ï¼ŸèŠå¤©è®°å½•å°†ä¼šæ¸…ç©ºã€‚')) { let conversations = JSON.parse(localStorage.getItem('conversations')) || []; conversations = conversations.filter(c => c.id !== groupId); localStorage.setItem('conversations', JSON.stringify(conversations)); DBHelper.getMessages(groupId).then(messages => Promise.all(messages.map(m => DBHelper.deleteMessage(m.id)))).finally(() => window.location.href = 'chat.html'); } }

    groupSettingsBtn.addEventListener('click', openGroupSettings); settingsBackBtn.addEventListener('click', closeGroupSettings); settingsGroupNameItem.addEventListener('click', handleChangeGroupName); settingsGroupAnnouncementItem.addEventListener('click', handleChangeGroupAnnouncement); settingsMyNicknameItem.addEventListener('click', handleChangeMyNickname); settingsManageGroupItem.addEventListener('click', openGroupManageModal); exitGroupBtn.addEventListener('click', handleExitGroup); reportGroupLink.addEventListener('click', () => alert('å·²æ”¶åˆ°æ‚¨çš„åé¦ˆï¼Œæˆ‘ä»¬å°†å°½å¿«å¤„ç†ã€‚')); closeMemberSelectModal.addEventListener('click', () => memberSelectModal.style.display = 'none'); confirmMemberSelectBtn.addEventListener('click', handleConfirmMemberSelection); closeGroupManageModal.addEventListener('click', () => { groupManageModal.style.display = 'none'; renderMessages(); }); manageMemberList.addEventListener('click', handleManageActions);
    rpDetailsCloseBtn.addEventListener('click', () => rpDetailsModal.style.display = 'none'); rpDetailsModal.addEventListener('click', (e) => { if (e.target === rpDetailsModal) rpDetailsModal.style.display = 'none'; });
    transferBtn.addEventListener('click', (e) => { e.stopPropagation(); financeMenu.style.left = `${transferBtn.offsetLeft + transferBtn.offsetWidth / 2}px`; financeMenu.style.display = 'block'; }); window.addEventListener('click', () => financeMenu.style.display = 'none'); menuDirectTransfer.addEventListener('click', () => handleDirectTransfer()); menuRedPacket.addEventListener('click', () => handleRedPacket()); cancelTransferBtn.addEventListener('click', () => { transferModal.style.display = 'none'; }); confirmTransferBtn.addEventListener('click', handleConfirmTransfer); cancelRpBtn.addEventListener('click', () => { redPacketModal.style.display = 'none'; }); confirmRpBtn.addEventListener('click', handleConfirmRp); transferAmountInput.addEventListener('input', validateTransferAmount); rpAmountInput.addEventListener('input', validateRp); rpCountInput.addEventListener('input', validateRp);
    messageArea.addEventListener('pointerdown', (e) => { const target = e.target.closest('.message-wrapper'); if (!target) return; clearTimeout(longPressTimer); longPressTimer = setTimeout(() => {  activeMessageElement = target; activeMessageId = parseInt(target.dataset.id, 10); const messageType = target.querySelector('.message').dataset.type; editBtn.style.display = ['text', 'voice', 'camera'].includes(messageType) ? 'block' : 'none'; contextMenu.style.left = `${e.clientX}px`; contextMenu.style.top = `${e.clientY}px`; contextMenu.style.display = 'block'; }, 500); });
    messageArea.addEventListener('pointerup', () => clearTimeout(longPressTimer)); messageArea.addEventListener('pointermove', () => clearTimeout(longPressTimer)); window.addEventListener('pointerdown', (e) => { if (contextMenu.style.display === 'block' && !contextMenu.contains(e.target) || atMentionPanel.style.display === 'block' && !atMentionPanel.contains(e.target)) { contextMenu.style.display = 'none'; hideAtMentionPanel(); } });
    atMessageBtn.addEventListener('click', handleAtFromMenu); replyBtn.addEventListener('click', handleStartReply); closeReplyPreviewBtn.addEventListener('click', cancelReply); deleteBtn.addEventListener('click', async () => { contextMenu.style.display = 'none'; if (activeMessageId) { if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡æ¶ˆæ¯å—ï¼Ÿ')) { await DBHelper.deleteMessage(activeMessageId); await renderMessages(); } } });
    editBtn.addEventListener('click', async () => { contextMenu.style.display = 'none'; if (activeMessageId && activeMessageElement) { const messageDiv = activeMessageElement.querySelector('.message'); const messageType = messageDiv.dataset.type; let currentContent = ''; if (messageType === 'text') { currentContent = messageDiv.querySelector('p').textContent; } else if (messageType === 'voice') { currentContent = messageDiv.querySelector('.text-content').textContent; } else if (messageType === 'camera') { currentContent = messageDiv.querySelector('p').textContent.slice(1, -1); } const newContent = prompt('ç¼–è¾‘æ¶ˆæ¯:', currentContent); if (newContent !== null) { const trimmedContent = newContent.trim(); await DBHelper.updateMessageContent(activeMessageId, trimmedContent); await renderMessages(); } } });
    regenerateBtn.addEventListener('click', handleRegenerate); sendButton.addEventListener('click', handleTextInput); transmitButton.addEventListener('click', handleTransmitToAI); voiceMessageBtn.addEventListener('click', handleVoiceInput); imageMessageBtn.addEventListener('click', () => imageUploader.click()); imageUploader.addEventListener('change', handleImageUpload ); cameraMessageBtn.addEventListener('click', handleCameraInput); emojiBtn.addEventListener('click', () => { renderStickerGrid(); stickerPanel.style.display = 'flex'; }); closeStickerPanelBtn.addEventListener('click', () => { stickerPanel.style.display = 'none'; }); addStickerBtn.addEventListener('click', handleAddSticker); stickerUploader.addEventListener('change', handleStickerUpload);
    messageInput.addEventListener('keydown', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleTextInput(); } });
    messageInput.addEventListener('input', () => {
        messageInput.style.height = 'auto'; messageInput.style.height = (messageInput.scrollHeight) + 'px';
        sendButton.classList.toggle('active', messageInput.value.trim() !== '');
        const text = messageInput.value;
        const cursorPos = messageInput.selectionStart;
        if (text[cursorPos - 1] === '@') {
            atMentionStartPosition = cursorPos - 1;
            isAtMentionActive = true;
            showAtMentionPanel();
        } else if (isAtMentionActive) {
            hideAtMentionPanel();
        }
    });
    initializeChat();
})();
</script>
</body>
</html>