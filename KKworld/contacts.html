<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>è”ç³»äºº</title>
    <link rel="stylesheet" href="qq_lobby_style.css">
    <link rel="stylesheet" href="contacts_style.css">
</head>
<body>

<div id="heads-up-notification" class="heads-up-notification"></div>

<div class="qq-container">
    <header class="top-bar"><div class="user-info"><div class="avatar-wrapper"><img src="images/default_avatar.png" id="user-avatar" alt="ç”¨æˆ·å¤´åƒ"></div><span class="page-title">è”ç³»äºº</span></div></header>
    <div class="search-bar"><span>ğŸ” æœç´¢</span></div>
    <div class="function-list"><div class="function-item" id="add-new-friend-btn"><span>æ–°æœ‹å‹</span><span class="arrow">></span></div></div>
    <div class="sub-nav"><div class="sub-nav-item active" data-tab="groups">åˆ†ç»„</div><div class="sub-nav-item" data-tab="group-chats">ç¾¤èŠ</div></div>
    <main id="main-content-container" class="friend-list"></main>
    <footer class="bottom-nav"><a href="chat.html" class="nav-item">æ¶ˆæ¯</a><a href="channels.html" class="nav-item">é¢‘é“</a><a href="contacts.html" class="nav-item active">è”ç³»äºº</a><a href="moments.html" class="nav-item">åŠ¨æ€</a></footer>
</div>

<div id="user-persona-modal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header"><h2>ç”¨æˆ·äººè®¾ç®¡ç†</h2><button id="close-user-persona-btn" class="close-button">Ã—</button></div>
        <div class="modal-body">
            <div class="settings-section">
                <h3>åˆ›å»ºæ–°äººè®¾</h3>
                <div class="form-group"><label for="user-persona-title-input">äººè®¾åç§°</label><input type="text" id="user-persona-title-input" placeholder="ä¾‹å¦‚ï¼šå†·é…·çš„æ€æ‰‹"></div>
                <div class="form-group"><label for="user-persona-content-input">äººè®¾Prompt</label><textarea id="user-persona-content-input" rows="5" placeholder="åœ¨æ­¤è¯¦ç»†æè¿°ä½ æ‰®æ¼”çš„è§’è‰²çš„æ€§æ ¼ã€èƒŒæ™¯ã€è¯´è¯æ–¹å¼..."></textarea></div>
                <button id="add-user-persona-btn" class="add-button">åˆ›å»ºäººè®¾</button>
            </div>
            <div class="settings-section">
                <h3>å·²æœ‰äººè®¾</h3>
                <div id="user-personas-list" class="user-persona-manager-list"></div>
            </div>
        </div>
    </div>
</div>

<div id="add-friend-modal" class="modal-overlay">
    <div class="modal-content">
        <h2>åˆ›å»ºæ–°è§’è‰²</h2>
        <form id="add-friend-form">
            <label for="friend-avatar-upload">å¤´åƒ:</label><div class="avatar-upload-preview"><img src="images/default_avatar.png" id="friend-avatar-preview" alt="å¤´åƒé¢„è§ˆ"><button type="button" id="trigger-avatar-upload">é€‰æ‹©å›¾ç‰‡</button><input type="file" id="friend-avatar-upload" accept="image/*" style="display:none;"></div>
            <label for="friend-name">åå­— (è§’è‰²è‡ªå·±çš„åå­—):</label><input type="text" id="friend-name" required>
            <label for="friend-nickname">å¤‡æ³¨ (æ‚¨å¯¹Taçš„ç§°å‘¼):</label><input type="text" id="friend-nickname">
            <label for="friend-group-select">é€‰æ‹©åˆ†ç»„:</label><select id="friend-group-select"></select>
            <label for="friend-tags">æ ‡ç­¾ (ç”¨è‹±æ–‡é€—å·,éš”å¼€ï¼Œæœ€å¤š5ä¸ª):</label><input type="text" id="friend-tags" placeholder="ä¾‹: æ¸©æŸ”,è…¹é»‘,çŒ«ç³»">
            <label for="friend-prompt">äººè®¾ (Prompt):</label><textarea id="friend-prompt" rows="5" placeholder="åœ¨è¿™é‡Œè¾“å…¥è§’è‰²çš„è¯¦ç»†äººè®¾..."></textarea>
            <div class="modal-actions"><button type="button" id="cancel-add-friend">å–æ¶ˆ</button><button type="submit">ä¿å­˜</button></div>
        </form>
    </div>
</div>

<div id="manage-groups-modal" class="modal-overlay">
    <div class="modal-content">
        <h2>åˆ†ç»„ç®¡ç†</h2>
        <div class="add-group-section"><input type="text" id="new-group-name" placeholder="è¾“å…¥æ–°åˆ†ç»„åç§°"><button id="add-group-btn">æ·»åŠ </button></div>
        <div id="groups-list-manager" class="groups-list-manager"></div>
        <div class="modal-actions"><button type="button" id="close-manage-groups">å®Œæˆ</button></div>
    </div>
</div>

<div id="profile-modal" class="modal-overlay profile-overlay">
    <div class="profile-modal-content">
        <div class="profile-header" id="profile-header"><a href="#" class="profile-back-button"><</a></div>
        <main class="profile-content">
            <div class="profile-info-card">
                <div id="profile-display-name" class="profile-display-name"></div>
                <p id="profile-signature" contenteditable="true" data-placeholder="ç‚¹å‡»è®¾ç½®ç­¾å..."></p>
            </div>
            <div class="card-section">
                <div class="card-title">å…³è”ç”¨æˆ·äººè®¾</div>
                <select id="profile-persona-select"></select>
            </div>
            <!-- ****** æ–°å¢ï¼šå…³è”ä¸–ç•Œä¹¦çš„å¡ç‰‡ ****** -->
            <div class="card-section">
                <div class="card-title">å…³è”ä¸–ç•Œä¹¦ (å¯å¤šé€‰)</div>
                <div id="profile-worldbook-select"></div>
            </div>
            <div class="card-section"><div class="card-title">è§’è‰²åˆ†ç»„</div><select id="profile-group-select"></select></div>
            <div class="card-section"><div class="card-title">è§’è‰²æ ‡ç­¾ (ç‚¹å‡»æ·»åŠ /åˆ é™¤)</div><div id="profile-tags-container" class="tags-container"></div></div>
            <details class="card-section"><summary class="card-title">æŸ¥çœ‹/ç¼–è¾‘è§’è‰²äººè®¾ (Prompt)</summary><p id="profile-prompt" class="prompt-text" contenteditable="true"></p></details>
            <div class="card-section"><div class="blacklist-item"><span>åŠ å…¥é»‘åå•</span><label class="switch"><input type="checkbox" id="blacklist-toggle"><span class="slider round"></span></label></div></div>
        </main>
        <footer class="profile-footer">
            <button id="send-message-btn" class="send-message-btn">å‘æ¶ˆæ¯</button>
            <button id="delete-friend-btn" class="delete-friend-btn">åˆ é™¤å¥½å‹</button>
            <a href="#" class="report-link">è¢«éªšæ‰°äº†ï¼Ÿä¸¾æŠ¥è¯¥ç”¨æˆ·</a>
        </footer>
    </div>
</div>

<div id="manage-group-chats-modal" class="modal-overlay">
    <div class="modal-content">
        <h2>ç¾¤èŠç®¡ç†</h2>
        <div id="group-chats-list-manager" class="group-chats-list-manager"></div>
        <div class="modal-actions"><button type="button" id="close-manage-group-chats">å®Œæˆ</button></div>
    </div>
</div>

<script>
(function() {
    const mainContentContainer = document.getElementById('main-content-container');
    const userAvatar = document.getElementById('user-avatar');
    const userPersonaModal = document.getElementById('user-persona-modal');
    const closeUserPersonaBtn = document.getElementById('close-user-persona-btn');
    const addUserPersonaBtn = document.getElementById('add-user-persona-btn');
    const userPersonaTitleInput = document.getElementById('user-persona-title-input');
    const userPersonaContentInput = document.getElementById('user-persona-content-input');
    const userPersonasList = document.getElementById('user-personas-list');
    const profilePersonaSelect = document.getElementById('profile-persona-select');
    // ****** æ–°å¢å˜é‡ ******
    const profileWorldbookSelect = document.getElementById('profile-worldbook-select');

    const subNavItems = document.querySelectorAll('.sub-nav-item');
    const addNewFriendBtn = document.getElementById('add-new-friend-btn');
    const addFriendModal = document.getElementById('add-friend-modal');
    const addFriendForm = document.getElementById('add-friend-form');
    const cancelAddFriendBtn = document.getElementById('cancel-add-friend');
    const triggerAvatarUploadBtn = document.getElementById('trigger-avatar-upload');
    const avatarUploadInput = document.getElementById('friend-avatar-upload');
    const avatarPreview = document.getElementById('friend-avatar-preview');
    const friendGroupSelect = document.getElementById('friend-group-select');
    const manageGroupsModal = document.getElementById('manage-groups-modal');
    const closeManageGroupsBtn = document.getElementById('close-manage-groups');
    const newGroupNameInput = document.getElementById('new-group-name');
    const addGroupBtn = document.getElementById('add-group-btn');
    const groupsListManager = document.getElementById('groups-list-manager');
    const profileModal = document.getElementById('profile-modal');
    const profileHeader = document.getElementById('profile-header');
    const profileBackButton = document.querySelector('.profile-back-button');
    const profileDisplayName = document.getElementById('profile-display-name');
    const profileSignature = document.getElementById('profile-signature');
    const profileGroupSelect = document.getElementById('profile-group-select');
    const profileTagsContainer = document.getElementById('profile-tags-container');
    const profilePrompt = document.getElementById('profile-prompt');
    const blacklistToggle = document.getElementById('blacklist-toggle');
    const deleteFriendBtn = document.getElementById('delete-friend-btn');
    const sendMessageBtn = document.getElementById('send-message-btn');
    const manageGroupChatsModal = document.getElementById('manage-group-chats-modal');
    const groupChatsListManager = document.getElementById('group-chats-list-manager');
    const closeManageGroupChatsBtn = document.getElementById('close-manage-group-chats');

    let friends = JSON.parse(localStorage.getItem('friends')) || [];
    let friendGroups = JSON.parse(localStorage.getItem('friendGroups')) || [];
    let conversations = JSON.parse(localStorage.getItem('conversations')) || [];
    let userPersonas = JSON.parse(localStorage.getItem('userPersonas')) || [];
    let newFriendAvatarData = null;
    let currentEditingFriendId = null;

    function loadUserAvatar() { const savedAvatar = localStorage.getItem('userAvatar'); if (savedAvatar) userAvatar.src = savedAvatar; }
    function saveUserPersonas() { localStorage.setItem('userPersonas', JSON.stringify(userPersonas)); }
    function renderUserPersonas() { userPersonasList.innerHTML = ''; if (userPersonas.length === 0) { userPersonasList.innerHTML = '<p class="empty-message">è¿˜æ²¡æœ‰ä»»ä½•äººè®¾ã€‚</p>'; return; } userPersonas.forEach((persona, index) => { const entryDiv = document.createElement('div'); entryDiv.className = 'user-persona-item'; entryDiv.innerHTML = `<div class="entry-header"><h4 class="entry-title">${persona.title}</h4><button class="delete-entry-btn" data-index="${index}">Ã—</button></div><p class="entry-content">${persona.content.replace(/\n/g, '<br>')}</p>`; userPersonasList.appendChild(entryDiv); }); }
    function openUserPersonaModal() { renderUserPersonas(); userPersonaModal.style.display = 'flex'; }
    function renderGroupList() { mainContentContainer.innerHTML = ''; if (friendGroups.length === 0) { friendGroups = [{ id: 'group_default', name: 'æˆ‘çš„å¥½å‹', deletable: false }]; localStorage.setItem('friendGroups', JSON.stringify(friendGroups)); } friendGroups.forEach(group => { const groupContainer = document.createElement('div'); groupContainer.className = 'group-container'; const groupHeader = document.createElement('div'); groupHeader.className = 'group-item'; const friendsInGroup = friends.filter(f => f.groupId === group.id); groupHeader.innerHTML = `<span class="group-arrow">></span><span class="group-name">${group.name}</span><span class="group-count">(${friendsInGroup.length})</span>`; const friendsContainer = document.createElement('div'); friendsContainer.className = 'friends-in-group'; if (friendsInGroup.length > 0) { friendsInGroup.forEach(friend => { const friendElement = document.createElement('div'); friendElement.className = 'friend-item'; friendElement.onclick = () => showProfileModal(friend.id); const avatarSrc = friend.avatar || 'images/default_avatar.png'; friendElement.innerHTML = `<img src="${avatarSrc}" class="friend-avatar" alt="å¥½å‹å¤´åƒ"><span class="friend-name">${friend.nickname || friend.name}</span>`; friendsContainer.appendChild(friendElement); }); } groupHeader.addEventListener('click', () => groupContainer.classList.toggle('open')); groupContainer.appendChild(groupHeader); groupContainer.appendChild(friendsContainer); mainContentContainer.appendChild(groupContainer); }); const manageGroupsElement = document.createElement('div'); manageGroupsElement.className = 'manage-groups-link'; manageGroupsElement.textContent = 'åˆ†ç»„ç®¡ç†'; manageGroupsElement.onclick = () => { renderGroupsInManager(); manageGroupsModal.style.display = 'flex'; }; mainContentContainer.appendChild(manageGroupsElement); }
    function renderGroupChatList() { mainContentContainer.innerHTML = ''; conversations = JSON.parse(localStorage.getItem('conversations')) || []; const groupChats = conversations.filter(c => c.isGroup); if (groupChats.length === 0) { mainContentContainer.innerHTML = '<p class="empty-message">è¿˜æ²¡æœ‰ç¾¤èŠ</p>'; } else { groupChats.forEach(groupChat => { const groupChatElement = document.createElement('a'); groupChatElement.className = 'group-chat-item'; groupChatElement.href = `group_conversation.html?groupId=${groupChat.id}`; const avatarSrc = groupChat.avatar || 'images/group_default_icon.svg'; groupChatElement.innerHTML = `<img src="${avatarSrc}" class="group-chat-avatar" alt="ç¾¤èŠå¤´åƒ"><span class="group-chat-name">${groupChat.name}</span>`; mainContentContainer.appendChild(groupChatElement); }); } const manageLink = document.createElement('div'); manageLink.className = 'manage-group-chats-link'; manageLink.textContent = 'ç¾¤èŠç®¡ç†'; manageLink.onclick = () => { renderGroupChatsInManager(); manageGroupChatsModal.style.display = 'flex'; }; mainContentContainer.appendChild(manageLink); }
    function switchTab(tabName) { if (tabName === 'groups') { renderGroupList(); } else if (tabName === 'group-chats') { renderGroupChatList(); } }
    subNavItems.forEach(tab => { tab.addEventListener('click', () => { subNavItems.forEach(t => t.classList.remove('active')); tab.classList.add('active'); switchTab(tab.dataset.tab); }); });
    function populateGroupSelect(selectElement) { selectElement.innerHTML = ''; friendGroups.forEach(group => { const option = document.createElement('option'); option.value = group.id; option.textContent = group.name; selectElement.appendChild(option); }); }
    function populatePersonaSelect(selectElement) { selectElement.innerHTML = '<option value="">é»˜è®¤ (æ— ç‰¹å®šäººè®¾)</option>'; userPersonas.forEach(persona => { const option = document.createElement('option'); option.value = persona.id; option.textContent = persona.title; selectElement.appendChild(option); }); }

    // ****** æ–°å¢ï¼šå¡«å……ä¸–ç•Œä¹¦å¤šé€‰åˆ—è¡¨çš„å‡½æ•° ******
    function populateWorldbookSelect(container, linkedIds = []) {
        const allWorldbookEntries = JSON.parse(localStorage.getItem('hakimi-os-worldbook')) || [];
        container.innerHTML = '';
        if (allWorldbookEntries.length === 0) {
            container.innerHTML = '<p class="empty-message" style="margin-top: 10px;">æ²¡æœ‰å¯ç”¨çš„ä¸–ç•Œä¹¦æ¡ç›®</p>';
            return;
        }
        allWorldbookEntries.forEach(entry => {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'worldbook-select-item';
            const isChecked = linkedIds.includes(entry.id);
            itemDiv.innerHTML = `
                <input type="checkbox" id="wb-select-${entry.id}" value="${entry.id}" ${isChecked ? 'checked' : ''}>
                <label for="wb-select-${entry.id}">${entry.title}</label>
            `;
            container.appendChild(itemDiv);
        });
    }

    addNewFriendBtn.addEventListener('click', () => { if (friendGroups.length === 0) renderGroupList(); populateGroupSelect(friendGroupSelect); addFriendModal.style.display = 'flex'; });
    cancelAddFriendBtn.addEventListener('click', () => addFriendModal.style.display = 'none');
    addFriendModal.addEventListener('click', (e) => { if (e.target === addFriendModal) addFriendModal.style.display = 'none'; });
    triggerAvatarUploadBtn.addEventListener('click', () => avatarUploadInput.click());
    avatarUploadInput.addEventListener('change', (event) => { const file = event.target.files[0]; if (file) { const reader = new FileReader(); reader.onload = (e) => { avatarPreview.src = e.target.result; newFriendAvatarData = e.target.result; }; reader.readAsDataURL(file); } });
    addFriendForm.addEventListener('submit', (event) => { event.preventDefault(); const tagsInput = document.getElementById('friend-tags').value; const tagsArray = tagsInput ? tagsInput.split(',').map(tag => tag.trim()).filter(Boolean).slice(0, 5) : []; const newFriend = { id: 'friend_' + Date.now(), name: document.getElementById('friend-name').value, nickname: document.getElementById('friend-nickname').value, groupId: friendGroupSelect.value, tags: tagsArray, signature: "", isBlacklisted: false, prompt: document.getElementById('friend-prompt').value, avatar: newFriendAvatarData }; friends.push(newFriend); localStorage.setItem('friends', JSON.stringify(friends)); if (document.querySelector('.sub-nav-item.active').dataset.tab === 'groups') { renderGroupList(); } addFriendForm.reset(); avatarPreview.src = 'images/default_avatar.png'; newFriendAvatarData = null; addFriendModal.style.display = 'none'; });
    function renderGroupsInManager() { groupsListManager.innerHTML = ''; friendGroups.forEach((group, index) => { const groupItem = document.createElement('div'); groupItem.className = 'group-manager-item'; let deleteButtonHTML = group.deletable ? `<button class="delete-btn" data-index="${index}">åˆ é™¤</button>` : ''; groupItem.innerHTML = `<span class="group-name">${group.name}</span>${deleteButtonHTML}`; groupsListManager.appendChild(groupItem); }); }
    closeManageGroupsBtn.addEventListener('click', () => { manageGroupsModal.style.display = 'none'; if (document.querySelector('.sub-nav-item.active').dataset.tab === 'groups') renderGroupList(); });
    addGroupBtn.addEventListener('click', () => { const newName = newGroupNameInput.value.trim(); if (newName) { friendGroups.push({ id: 'group_' + Date.now(), name: newName, deletable: true }); localStorage.setItem('friendGroups', JSON.stringify(friendGroups)); renderGroupsInManager(); newGroupNameInput.value = ''; } });
    groupsListManager.addEventListener('click', (event) => { if (event.target.classList.contains('delete-btn')) { const indexToDelete = parseInt(event.target.dataset.index, 10); const groupNameToDelete = friendGroups[indexToDelete].name; if (confirm(`ç¡®å®šè¦åˆ é™¤åˆ†ç»„ "${groupNameToDelete}" å—ï¼Ÿè¯¥åˆ†ç»„ä¸‹çš„å¥½å‹å°†ç§»è‡³é»˜è®¤åˆ†ç»„ã€‚`)) { const deletedGroupId = friendGroups[indexToDelete].id; friends.forEach(friend => { if(friend.groupId === deletedGroupId) friend.groupId = friendGroups[0].id; }); localStorage.setItem('friends', JSON.stringify(friends)); friendGroups.splice(indexToDelete, 1); localStorage.setItem('friendGroups', JSON.stringify(friendGroups)); renderGroupsInManager(); } } });
    function renderGroupChatsInManager() { groupChatsListManager.innerHTML = ''; conversations = JSON.parse(localStorage.getItem('conversations')) || []; const groupChats = conversations.filter(c => c.isGroup); if (groupChats.length === 0) { groupChatsListManager.innerHTML = '<p class="empty-message">æ²¡æœ‰ç¾¤èŠå¯ç®¡ç†</p>'; } else { groupChats.forEach(groupChat => { const item = document.createElement('div'); item.className = 'group-chat-manager-item'; item.innerHTML = `<span class="group-name">${groupChat.name}</span><button class="delete-btn" data-id="${groupChat.id}">åˆ é™¤</button>`; groupChatsListManager.appendChild(item); }); } }
    groupChatsListManager.addEventListener('click', (event) => { if (event.target.classList.contains('delete-btn')) { const idToDelete = event.target.dataset.id; const groupChatToDelete = conversations.find(c => c.id === idToDelete); if (groupChatToDelete && confirm(`ç¡®å®šè¦è§£æ•£ç¾¤èŠ "${groupChatToDelete.name}" å—ï¼Ÿ`)) { conversations = conversations.filter(c => c.id !== idToDelete); localStorage.setItem('conversations', JSON.stringify(conversations)); renderGroupChatsInManager(); } } });
    closeManageGroupChatsBtn.addEventListener('click', () => { manageGroupChatsModal.style.display = 'none'; renderGroupChatList(); });

    function showProfileModal(friendId) {
        currentEditingFriendId = friendId;
        const friend = friends.find(f => f.id === friendId);
        if (!friend) return;
        const avatarUrl = friend.avatar || 'images/default_avatar.png';
        profileHeader.style.backgroundImage = `url('${avatarUrl}')`;
        profileDisplayName.innerHTML = `<strong id="profile-editable-nickname" contenteditable="true">${friend.nickname || 'æœªè®¾ç½®å¤‡æ³¨'}</strong> (<span>${friend.name}</span>)`;
        profileSignature.textContent = friend.signature || '';
        profilePrompt.textContent = friend.prompt || '';
        blacklistToggle.checked = friend.isBlacklisted || false;
        populateGroupSelect(profileGroupSelect);
        profileGroupSelect.value = friend.groupId;
        populatePersonaSelect(profilePersonaSelect);
        profilePersonaSelect.value = friend.linkedPersonaId || '';
        // ****** æ–°å¢è°ƒç”¨ ******
        populateWorldbookSelect(profileWorldbookSelect, friend.linkedWorldbookIds || []);
        renderProfileTags(friend.tags || []);
        profileModal.style.display = 'flex';
    }

    function renderProfileTags(tags) { profileTagsContainer.innerHTML = ''; tags.forEach(tagText => { const tagElement = document.createElement('span'); tagElement.className = 'tag'; tagElement.textContent = tagText; tagElement.onclick = () => removeTag(tagText); profileTagsContainer.appendChild(tagElement); }); if (tags.length < 5) { const addTagElement = document.createElement('span'); addTagElement.className = 'tag add-tag'; addTagElement.textContent = '+'; addTagElement.onclick = addNewTag; profileTagsContainer.appendChild(addTagElement); } }
    function addNewTag() { const newTag = prompt('è¯·è¾“å…¥æ–°æ ‡ç­¾:'); if (newTag && newTag.trim() !== '') { const friend = friends.find(f => f.id === currentEditingFriendId); if (friend) { if (!friend.tags) friend.tags = []; if (friend.tags.length < 5) { friend.tags.push(newTag.trim()); saveCurrentFriendData(false); renderProfileTags(friend.tags); } else { alert('æœ€å¤šåªèƒ½æ·»åŠ 5ä¸ªæ ‡ç­¾ã€‚'); } } } }
    function removeTag(tagToRemove) { const friend = friends.find(f => f.id === currentEditingFriendId); if (friend && friend.tags) { friend.tags = friend.tags.filter(tag => tag !== tagToRemove); saveCurrentFriendData(false); renderProfileTags(friend.tags); } }

    function saveCurrentFriendData(shouldReloadList = true) {
        if (!currentEditingFriendId) return;
        const friendIndex = friends.findIndex(f => f.id === currentEditingFriendId);
        if (friendIndex > -1) {
            const editableNickname = document.getElementById('profile-editable-nickname');
            if(editableNickname) friends[friendIndex].nickname = editableNickname.textContent;
            friends[friendIndex].signature = profileSignature.textContent;
            friends[friendIndex].groupId = profileGroupSelect.value;
            friends[friendIndex].prompt = profilePrompt.textContent;
            friends[friendIndex].isBlacklisted = blacklistToggle.checked;
            friends[friendIndex].linkedPersonaId = profilePersonaSelect.value;

            // ****** æ–°å¢ä¿å­˜é€»è¾‘ ******
            const selectedWorldbookCheckboxes = profileWorldbookSelect.querySelectorAll('input[type="checkbox"]:checked');
            friends[friendIndex].linkedWorldbookIds = Array.from(selectedWorldbookCheckboxes).map(cb => cb.value);

            localStorage.setItem('friends', JSON.stringify(friends));
            if (shouldReloadList) renderGroupList();
        }
    }
    profileBackButton.addEventListener('click', (e) => { e.preventDefault(); saveCurrentFriendData(); profileModal.style.display = 'none'; });
    deleteFriendBtn.addEventListener('click', () => { const friend = friends.find(f => f.id === currentEditingFriendId); if (confirm(`ç¡®å®šè¦åˆ é™¤å¥½å‹ "${friend.name}" å—ï¼Ÿæ­¤æ“ä½œä¸å¯é€†ï¼`)) { friends = friends.filter(f => f.id !== currentEditingFriendId); localStorage.setItem('friends', JSON.stringify(friends)); profileModal.style.display = 'none'; renderGroupList(); } });
    sendMessageBtn.addEventListener('click', () => { saveCurrentFriendData(false); const friend = friends.find(f => f.id === currentEditingFriendId); let conversation = conversations.find(c => !c.isGroup && c.friendId === currentEditingFriendId); if(!conversation) { conversation = { id: 'chat_' + Date.now(), friendId: friend.id, name: friend.nickname || friend.name, avatar: friend.avatar || 'images/default_avatar.png', time: new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' }), lastMessage: 'ä½ ä»¬ç°åœ¨å¯ä»¥å¼€å§‹èŠå¤©äº†...', unreadCount: 0, isPinned: false, isGroup: false }; conversations.unshift(conversation); localStorage.setItem('conversations', JSON.stringify(conversations)); } window.location.href = `conversation.html?friendId=${currentEditingFriendId}`; });
    userAvatar.addEventListener('click', openUserPersonaModal);
    closeUserPersonaBtn.addEventListener('click', () => userPersonaModal.style.display = 'none');
    userPersonaModal.addEventListener('click', (e) => { if(e.target === userPersonaModal) userPersonaModal.style.display = 'none'; });
    addUserPersonaBtn.addEventListener('click', () => { const title = userPersonaTitleInput.value.trim(); const content = userPersonaContentInput.value.trim(); if (title && content) { userPersonas.unshift({ id: 'persona_' + Date.now(), title, content }); saveUserPersonas(); renderUserPersonas(); userPersonaTitleInput.value = ''; userPersonaContentInput.value = ''; } else { alert('äººè®¾åç§°å’ŒPromptå‡ä¸èƒ½ä¸ºç©ºï¼'); } });
    userPersonasList.addEventListener('click', (event) => { if (event.target.classList.contains('delete-entry-btn')) { const indexToDelete = parseInt(event.target.getAttribute('data-index'), 10); if (confirm(`ç¡®å®šè¦åˆ é™¤äººè®¾ "${userPersonas[indexToDelete].title}" å—ï¼Ÿ`)) { userPersonas.splice(indexToDelete, 1); saveUserPersonas(); renderUserPersonas(); } } });
    loadUserAvatar();
    switchTab('groups');
})();
</script>

<script src="main.js"></script>

</body>
</html>