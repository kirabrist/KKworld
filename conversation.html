<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>èŠå¤©</title>
    <link rel="stylesheet" href="conversation_style.css">
</head>
<body>
    <div class="chat-container">
        <header class="header">
            <a href="chat.html" class="back-button"><</a>
            <div class="friend-info"><span id="friend-name" class="name">åŠ è½½ä¸­...</span><span id="status-indicator" class="status">ğŸŸ¢ åœ¨çº¿</span></div>
            <img src="images/menu_icon.svg" class="more-options" alt="æ›´å¤š">
        </header>
        <main id="message-area" class="message-area"></main>
        <div class="input-area">
            <textarea id="message-input" placeholder="è¾“å…¥æ¶ˆæ¯..." rows="1"></textarea>
            <button id="transmit-button" title="å‘é€ç»™AIè¿›è¡Œå›å¤"><img src="images/transmit_icon.svg" alt="ä¼ è¾“"></button>
            <button id="send-button">å‘é€</button>
        </div>
        <footer class="action-bar"><img id="voice-message-btn" src="images/mic_icon.svg" alt="è¯­éŸ³"><img id="image-message-btn" src="images/image_icon.svg" alt="å›¾ç‰‡"><img id="camera-message-btn" src="images/camera_icon.svg" alt="ç›¸æœº"><img id="transfer-btn" src="images/wallet_icon.svg" alt="è½¬è´¦"><img id="emoji-btn" src="images/emoji_icon.svg" alt="è¡¨æƒ…"><img id="plus-icon" src="images/plus_icon.svg" alt="æ›´å¤šåŠŸèƒ½"></footer>
        <div id="sticker-panel" class="sticker-panel"><div class="sticker-panel-header"><span>è¡¨æƒ…åŒ…</span><div><button id="add-sticker-btn">æ·»åŠ </button> <button id="close-sticker-panel-btn">å…³é—­</button></div></div><div id="sticker-grid" class="sticker-grid"></div></div>
        <input type="file" id="image-uploader" accept="image/*" style="display: none;"><input type="file" id="sticker-uploader" accept="image/*" style="display: none;">
        <div id="transfer-modal" class="modal-overlay"><div class="modal-content"><h2 id="transfer-title">è½¬è´¦</h2><div class="transfer-form-group"><label for="transfer-amount-input">è½¬è´¦é‡‘é¢</label><input type="number" id="transfer-amount-input" placeholder="0.00" step="0.01"><div id="transfer-error" class="error-message"></div></div><div class="transfer-form-group"><label for="transfer-remark-input">å¤‡æ³¨ (æœ€å¤š20å­—)</label><input type="text" id="transfer-remark-input" maxlength="20"></div><div class="modal-actions"><button id="cancel-transfer-btn">å–æ¶ˆ</button><button id="confirm-transfer-btn" disabled>è½¬è´¦</button></div></div></div>
    </div>
    <script>
        (function() {
            const friendNameElement = document.getElementById('friend-name');
            const statusIndicator = document.getElementById('status-indicator');
            const messageArea = document.getElementById('message-area');
            const messageInput = document.getElementById('message-input');
            const sendButton = document.getElementById('send-button');
            const transmitButton = document.getElementById('transmit-button');
            const voiceMessageBtn = document.getElementById('voice-message-btn');
            const imageMessageBtn = document.getElementById('image-message-btn');
            const cameraMessageBtn = document.getElementById('camera-message-btn');
            const imageUploader = document.getElementById('image-uploader');
            const transferBtn = document.getElementById('transfer-btn');
            const transferModal = document.getElementById('transfer-modal');
            const transferTitle = document.getElementById('transfer-title');
            const transferAmountInput = document.getElementById('transfer-amount-input');
            const transferRemarkInput = document.getElementById('transfer-remark-input');
            const confirmTransferBtn = document.getElementById('confirm-transfer-btn');
            const cancelTransferBtn = document.getElementById('cancel-transfer-btn');
            const transferError = document.getElementById('transfer-error');
            const emojiBtn = document.getElementById('emoji-btn');
            const stickerPanel = document.getElementById('sticker-panel');
            const stickerGrid = document.getElementById('sticker-grid');
            const addStickerBtn = document.getElementById('add-sticker-btn');
            const closeStickerPanelBtn = document.getElementById('close-sticker-panel-btn');
            const stickerUploader = document.getElementById('sticker-uploader');
            let friendData = {}; let userData = {}; let friendId = null; let userStickers = [];

            const DBHelper = { db: null, openDB: function() { return new Promise((resolve, reject) => { if (this.db) { return resolve(this.db); } const request = indexedDB.open('ChatDatabase', 2); request.onerror = (event) => reject("æ•°æ®åº“é”™è¯¯: " + event.target.errorCode); request.onsuccess = (event) => { this.db = event.target.result; resolve(this.db); }; request.onupgradeneeded = (event) => { const db = event.target.result; if (!db.objectStoreNames.contains('conversations')) { const store = db.createObjectStore('conversations', { keyPath: 'id', autoIncrement: true }); store.createIndex('conversationId', 'conversationId', { unique: false }); }}; }); }, addMessage: async function(conversationId, message) { const db = await this.openDB(); return new Promise((resolve, reject) => { const transaction = db.transaction(['conversations'], 'readwrite'); const store = transaction.objectStore('conversations'); message.conversationId = conversationId; const request = store.add(message); request.onsuccess = resolve; request.onerror = (event) => reject("æ·»åŠ æ¶ˆæ¯å¤±è´¥: " + event.target.error); }); }, getMessages: async function(conversationId) { const db = await this.openDB(); return new Promise((resolve, reject) => { const transaction = db.transaction(['conversations'], 'readonly'); const store = transaction.objectStore('conversations'); const index = store.index('conversationId'); const request = index.getAll(conversationId); request.onsuccess = () => resolve(request.result.sort((a,b) => a.timestamp - b.timestamp)); request.onerror = (event) => reject("è·å–æ¶ˆæ¯å¤±è´¥: " + event.target.error); }); } };

            async function getAIResponse(chatHistory, apiKey, apiEndpoint, apiModel) {
                const textHistory = chatHistory.filter(msg => msg.type === 'text');
                if (textHistory.length === 0) return "(å½“å‰æ²¡æœ‰å¯ä¾›AIç†è§£çš„æ–‡æœ¬æ¶ˆæ¯ã€‚)";
                const messagesForAI = textHistory.map(msg => ({ role: msg.sender === 'me' ? 'user' : 'assistant', content: msg.content }));
                statusIndicator.textContent = 'å¯¹æ–¹æ­£åœ¨è¾“å…¥...';
                try {
                    const response = await fetch(apiEndpoint, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
                        body: JSON.stringify({ model: apiModel, messages: messagesForAI })
                    });
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error?.message || `HTTP ${response.status}`);
                    }
                    const data = await response.json();
                    return data.choices[0].message.content;
                } catch (error) {
                    console.error('è°ƒç”¨AIå¤±è´¥:', error);
                    return `(æŠ±æ­‰ï¼ŒAIè¿æ¥å‡ºç°é—®é¢˜: ${error.message})`;
                } finally {
                    statusIndicator.textContent = 'ğŸŸ¢ åœ¨çº¿';
                }
            }
            async function initializeChat() { const params = new URLSearchParams(window.location.search); friendId = params.get('friendId'); if (!friendId) { friendNameElement.textContent = 'é”™è¯¯ï¼šæœªæ‰¾åˆ°å¥½å‹'; return; } const allFriends = JSON.parse(localStorage.getItem('friends')) || []; friendData = allFriends.find(f => f.id === friendId); if (!friendData) { friendNameElement.textContent = 'é”™è¯¯ï¼šå¥½å‹ä¸å­˜åœ¨'; return; } userData.avatar = localStorage.getItem('userAvatar') || 'images/default_avatar.png'; friendNameElement.textContent = friendData.nickname || friendData.name; document.title = `ä¸ ${friendNameElement.textContent} çš„èŠå¤©`; loadUserStickers(); await renderMessages(); }
            async function renderMessages() { messageArea.innerHTML = ''; try { const conversationHistory = await DBHelper.getMessages(friendId); conversationHistory.forEach(msg => appendMessageToUI(msg)); } catch (error) { console.error("æ¸²æŸ“æ¶ˆæ¯å¤±è´¥:", error); } messageArea.scrollTop = messageArea.scrollHeight; }
            function appendMessageToUI(msg) { const messageWrapper = document.createElement('div'); messageWrapper.className = 'message-wrapper'; const messageDiv = document.createElement('div'); messageDiv.className = 'message'; const avatarImg = document.createElement('img'); avatarImg.className = 'avatar'; if (msg.type === 'text') { messageDiv.classList.add('text'); messageDiv.innerHTML = `<p>${msg.content}</p>`; } else if (msg.type === 'voice') { messageDiv.classList.add('voice'); const waveHTML = `<div class="sound-waves"><span class="bar" style="height: 60%;"></span><span class="bar" style="height: 100%;"></span><span class="bar" style="height: 80%;"></span><span class="bar" style="height: 40%;"></span></div>`; messageDiv.innerHTML = `<div class="voice-display"><svg class="play-icon-svg" viewBox="0 0 8 12"><path d="M0 12L10 6L0 0V12Z"/></svg>${waveHTML}<span class="duration">${msg.duration}"</span></div><div class="transcribed-text"><div class="text-content">${msg.content}</div><div class="collapse-arrow">^</div></div>`; messageDiv.onclick = function() { this.classList.toggle('is-transcribed'); }; } else if (msg.type === 'image') { messageDiv.classList.add('image'); if (msg.content instanceof Blob) { const imageUrl = URL.createObjectURL(msg.content); messageDiv.innerHTML = `<img src="${imageUrl}" alt="å‘é€çš„å›¾ç‰‡">`; } } else if (msg.type === 'camera') { messageDiv.classList.add('camera'); messageDiv.innerHTML = `<div class="camera-placeholder"><p>[${msg.content}]</p></div>`; } else if (msg.type === 'transfer') { messageDiv.classList.add('transfer'); const remarkText = msg.content.remark ? msg.content.remark : 'è½¬è´¦'; messageDiv.innerHTML = `<div class="transfer-content"><div class="transfer-header"><span>ğŸ’°</span><span>è½¬è´¦ç»™ ${friendData.nickname || friendData.name}</span></div><div class="transfer-amount"><small>Â¥</small>${msg.content.amount}</div><div class="transfer-remark">${remarkText}</div></div><div class="transfer-footer">å“ˆåŸºç±³OS è½¬è´¦</div>`; } else if (msg.type === 'sticker') { messageDiv.classList.add('sticker'); messageDiv.innerHTML = `<img src="${msg.content}" alt="è¡¨æƒ…åŒ…">`; } if (msg.sender === 'me') { messageWrapper.classList.add('sent'); avatarImg.src = userData.avatar; messageWrapper.appendChild(messageDiv); messageWrapper.appendChild(avatarImg); } else { messageWrapper.classList.add('received'); avatarImg.src = friendData.avatar || 'images/default_avatar.png'; messageWrapper.appendChild(avatarImg); messageWrapper.appendChild(messageDiv); } messageArea.appendChild(messageWrapper); messageArea.scrollTop = messageArea.scrollHeight; }
            async function sendMessageToScreen(msgObject) { await DBHelper.addMessage(friendId, msgObject); let lastMessageText; if (msgObject.type === 'text') { lastMessageText = msgObject.content; } else { lastMessageText = `[${{voice: 'è¯­éŸ³', image: 'å›¾ç‰‡', camera: 'ç…§ç‰‡', transfer: 'è½¬è´¦', sticker: 'è¡¨æƒ…'}[msgObject.type]}]`; } updateConversationList(lastMessageText, msgObject.sender); appendMessageToUI(msgObject); }
            function handleTextInput() { const text = messageInput.value.trim(); if (text === '') return; const newMessage = { sender: 'me', content: text, type: 'text', timestamp: Date.now() }; sendMessageToScreen(newMessage); messageInput.value = ''; messageInput.style.height = 'auto'; messageInput.focus(); }
            async function handleTransmitToAI() { const apiEndpoint = localStorage.getItem('hakimi-os-api-endpoint'); const apiKey = localStorage.getItem('hakimi-os-api-key'); const apiModel = localStorage.getItem('hakimi-os-api-model'); if (!apiEndpoint || !apiKey || !apiModel) { await sendMessageToScreen({ sender: 'friend', content: '(é”™è¯¯: æœªåœ¨ä¸»å±å¹•è®¾ç½®ä¸­å®Œæ•´é…ç½®AIå‚æ•°ã€‚)', type: 'text', timestamp: Date.now() }); return; } const history = await DBHelper.getMessages(friendId); const aiReplyText = await getAIResponse(history, apiKey, apiEndpoint, apiModel); const aiMessage = { sender: 'friend', content: aiReplyText, type: 'text', timestamp: Date.now() }; await sendMessageToScreen(aiMessage); }
            function handleVoiceInput() { const text = prompt("è¯·è¾“å…¥è¦è½¬ä¸ºè¯­éŸ³çš„æ¶ˆæ¯å†…å®¹ï¼š"); if (text && text.trim() !== '') { const duration = Math.max(1, Math.round(text.length / 4)); const newMessage = { sender: 'me', content: text.trim(), type: 'voice', duration: duration, timestamp: Date.now() }; sendMessageToScreen(newMessage); } }
            function handleImageUpload(event) { const file = event.target.files[0]; if (!file) return; const newMessage = { sender: 'me', content: file, type: 'image', timestamp: Date.now() }; sendMessageToScreen(newMessage); event.target.value = ''; }
            function handleCameraInput() { const text = prompt("è¯·ç®€çŸ­æè¿°æ‚¨â€œæ‹æ‘„â€çš„ç…§ç‰‡ï¼š"); if (text && text.trim() !== '') { const newMessage = { sender: 'me', content: text.trim(), type: 'camera', timestamp: Date.now() }; sendMessageToScreen(newMessage); } }
            function handleTransferInput() { transferTitle.textContent = `è½¬è´¦ç»™ ${friendData.nickname || friendData.name}`; transferModal.style.display = 'flex'; }
            function handleConfirmTransfer() { const amount = parseFloat(transferAmountInput.value); const remark = transferRemarkInput.value.trim(); const newMessage = { sender: 'me', content: { amount: amount.toFixed(2), remark: remark || ' ' }, type: 'transfer', timestamp: Date.now() }; sendMessageToScreen(newMessage); transferModal.style.display = 'none'; transferAmountInput.value = ''; transferRemarkInput.value = ''; }
            function validateTransferAmount() { const amount = parseFloat(transferAmountInput.value); if (isNaN(amount) || amount <= 0) { transferError.textContent = 'é‡‘é¢å¿…é¡»å¤§äº0'; confirmTransferBtn.disabled = true; } else if (amount > 50000) { transferError.textContent = 'å•ç¬”è½¬è´¦é‡‘é¢ä¸èƒ½è¶…è¿‡50,000'; confirmTransferBtn.disabled = true; } else { transferError.textContent = ''; confirmTransferBtn.disabled = false; } }
            function updateConversationList(lastMessage, sender) { let conversations = JSON.parse(localStorage.getItem('conversations')) || []; const conversationIndex = conversations.findIndex(c => !c.isGroup && c.friendId === friendId); if (conversationIndex > -1) { const prefix = sender === 'me' ? '[æˆ‘]: ' : ''; conversations[conversationIndex].lastMessage = prefix + lastMessage; conversations[conversationIndex].time = new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' }); const itemToMove = conversations.splice(conversationIndex, 1)[0]; conversations.unshift(itemToMove); localStorage.setItem('conversations', JSON.stringify(conversations)); } }
            function loadUserStickers() { userStickers = JSON.parse(localStorage.getItem('userStickers')) || []; }
            function saveUserStickers() { localStorage.setItem('userStickers', JSON.stringify(userStickers)); }
            function renderStickerGrid() { stickerGrid.innerHTML = ''; userStickers.forEach(stickerSrc => { const stickerItem = document.createElement('div'); stickerItem.className = 'sticker-item'; stickerItem.innerHTML = `<img src="${stickerSrc}" alt="sticker">`; stickerItem.onclick = () => { sendSticker(stickerSrc); }; stickerGrid.appendChild(stickerItem); }); }
            function handleAddSticker() { const choice = confirm("æ·»åŠ ç½‘ç»œå›¾ç‰‡å—ï¼Ÿ (ç‚¹'å–æ¶ˆ'ä»¥ä¸Šä¼ æœ¬åœ°æ–‡ä»¶)"); if (choice) { const url = prompt("è¯·è¾“å…¥å›¾ç‰‡é“¾æ¥ (URL):"); if (url) { userStickers.push(url); saveUserStickers(); renderStickerGrid(); } } else { stickerUploader.click(); } }
            function handleStickerUpload(event) { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (e) => { userStickers.push(e.target.result); saveUserStickers(); renderStickerGrid(); }; reader.readAsDataURL(file); event.target.value = ''; }
            function sendSticker(src) { const newMessage = { sender: 'me', content: src, type: 'sticker', timestamp: Date.now() }; sendMessageToScreen(newMessage); stickerPanel.style.display = 'none'; }
            sendButton.addEventListener('click', handleTextInput); transmitButton.addEventListener('click', handleTransmitToAI); voiceMessageBtn.addEventListener('click', handleVoiceInput); imageMessageBtn.addEventListener('click', () => imageUploader.click()); imageUploader.addEventListener('change', handleImageUpload); cameraMessageBtn.addEventListener('click', handleCameraInput); transferBtn.addEventListener('click', handleTransferInput); cancelTransferBtn.addEventListener('click', () => { transferModal.style.display = 'none'; }); confirmTransferBtn.addEventListener('click', handleConfirmTransfer); emojiBtn.addEventListener('click', () => { renderStickerGrid(); stickerPanel.style.display = 'flex'; }); closeStickerPanelBtn.addEventListener('click', () => { stickerPanel.style.display = 'none'; }); addStickerBtn.addEventListener('click', handleAddSticker); stickerUploader.addEventListener('change', handleStickerUpload); transferAmountInput.addEventListener('input', validateTransferAmount); messageInput.addEventListener('keydown', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleTextInput(); } });
            messageInput.addEventListener('input', () => { messageInput.style.height = 'auto'; messageInput.style.height = (messageInput.scrollHeight) + 'px'; sendButton.classList.toggle('active', messageInput.value.trim() !== ''); });
            initializeChat();
        })();
    </script>
</body>
</html>